import{C as M,a as D}from"./case-transform.js";class v{constructor(){this.logs=[],this.debugMode=!1,this.maxLogs=100,this.sessionId=`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static getInstance(){return v.instance||(v.instance=new v),v.instance}setDebugMode(t){this.debugMode=t}addLog(t){t.context||(t.context={}),t.context.sessionId=this.sessionId,this.logs.push(t),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs))}info(t,e,n){const s={level:"info",category:t,message:e,context:n,timestamp:Date.now()};this.addLog(s),this.debugMode&&console.log(`TextBlitz [${t}]:`,e,n||"")}warn(t,e,n){const s={level:"warn",category:t,message:e,context:n,timestamp:Date.now()};this.addLog(s),this.debugMode&&console.warn(`TextBlitz [${t}]:`,e,n||"")}error(t,e,n){const s={level:"error",category:t,message:e,context:n,timestamp:Date.now()};this.addLog(s),console.error(`TextBlitz [${t}]:`,e,n||"")}debug(t,e,n){const s={level:"debug",category:t,message:e,context:n,timestamp:Date.now()};this.addLog(s),this.debugMode&&console.log(`TextBlitz [${t}] DEBUG:`,e,n||"")}getElementContext(t){return{tag:t.tagName,type:t instanceof HTMLInputElement?t.type:void 0,id:t.id||void 0,classes:t.className||void 0,contentEditable:t.isContentEditable}}getSiteContext(){return{hostname:window.location.hostname,url:window.location.href}}getRecentLogs(t=50){return this.logs.slice(-t)}getLogsByCategory(t){return this.logs.filter(e=>e.category===t)}getErrors(){return this.logs.filter(t=>t.level==="error")}formatForGitHub(){const t=this.getErrors(),e=this.getRecentLogs(20);let n=`## TextBlitz Error Report

`;return n+=`**Session ID:** ${this.sessionId}
`,n+=`**Timestamp:** ${new Date().toISOString()}
`,n+=`**Site:** ${window.location.hostname}
`,n+=`**User Agent:** ${navigator.userAgent}

`,t.length>0&&(n+=`### Errors

`,t.forEach(s=>{n+=`- **${s.category}** (${new Date(s.timestamp).toISOString()}): ${s.message}
`,s.context&&(n+=`  \`\`\`json
  ${JSON.stringify(s.context,null,2)}
  \`\`\`
`)}),n+=`
`),n+=`### Recent Activity (Last 20 events)

`,n+="```\n",e.forEach(s=>{const i=new Date(s.timestamp).toISOString().split("T")[1].split(".")[0];n+=`[${i}] ${s.level.toUpperCase()} ${s.category}: ${s.message}
`}),n+="```\n",n}clearLogs(){this.logs=[]}}const p=v.getInstance();class m{constructor(){this.debugMode=!1}setDebugMode(t){this.debugMode=t}log(...t){this.debugMode&&console.log(`[${this.name}]`,...t)}async delay(t){return new Promise(e=>setTimeout(e,t))}getElementText(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value:t.textContent||""}findTrigger(t,e){if(t.endsWith(e))return{start:t.length-e.length,end:t.length};const n=t.lastIndexOf(e);return n!==-1?{start:n,end:n+e.length}:null}verify(t,e,n){const s=this.getElementText(t),i=e.substring(0,Math.min(10,e.length));return s.includes(i)?s.endsWith(n)?(this.log("Verification failed: trigger still present"),!1):!0:(this.log("Verification failed: expansion not found"),!1)}async executeKeyboardAction(t,e){switch(e.type){case"enter":await this.executeEnter(t);break;case"tab":await this.executeTab(t);break;case"delay":await this.executeDelay(e.options);break}}async executeEnter(t){if(this.log("Executing {enter}"),t instanceof HTMLTextAreaElement||t.isContentEditable){const e=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,bubbles:!0,cancelable:!0});t.dispatchEvent(e)}else if(t instanceof HTMLInputElement){const e=t.form;e?e.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0})):t.blur()}}async executeTab(t){this.log("Executing {tab}");const e=Array.from(document.querySelectorAll('input:not([disabled]):not([type="hidden"]), textarea:not([disabled]), select:not([disabled]), button:not([disabled]), [contenteditable="true"], [tabindex]:not([tabindex="-1"])')),n=e.indexOf(t);n!==-1&&n<e.length-1&&e[n+1].focus()}async executeDelay(t){let n=1e3;if(t){const s=t.match(/\+?(\d+(?:\.\d+)?)(s|ms)?/);if(s){const i=parseFloat(s[1]);n=(s[2]||"s")==="ms"?i:i*1e3}}this.log(`Executing {delay} for ${n}ms`),await this.delay(n)}}class H{static isGoogleDocs(t){return!!(window.location.hostname.includes("docs.google.com")||t&&(t.classList.contains("kix-cursor")||t.closest(".kix-appview-editor")||document.querySelector(".kix-appview-editor")))}static isReact(t){return Object.keys(t).some(n=>n.startsWith("__react")||n.startsWith("_react")||n.startsWith("__REACT"))}static isVue(t){return"__vue__"in t||"__vueParentComponent"in t||"__v_skip"in t}static isShadowDOM(t){return!!t.shadowRoot||!!t.closest("[shadowroot]")}static isCustomEditor(t){return t.classList.contains("CodeMirror")||t.classList.contains("monaco-editor")||t.getAttribute("data-lexical-editor")!==null||t.classList.contains("ProseMirror")}static getSiteType(t){return this.isGoogleDocs(t)?"google-docs":this.isCustomEditor(t)?"custom-editor":this.isReact(t)?"react":this.isVue(t)?"vue":this.isShadowDOM(t)?"shadow-dom":"standard"}}class L extends m{constructor(){super(...arguments),this.name="GoogleDocs",this.priority=10}canHandle(t){return H.isGoogleDocs(t)}async replace(t,e,n,s,i,a){if(this.log("Starting Google Docs replacement"),t.focus(),await this.delay(50),!this.getElementText(t).endsWith(e))return this.log("Trigger not found at end of text"),!1;for(let d=0;d<e.length;d++)document.execCommand("delete",!1);await this.delay(100);let l=0,o=this.getElementText(t);for(;o.endsWith(e)&&l<3;){this.log(`Deletion retry ${l+1}/3`);const d=window.getSelection();if(d&&d.rangeCount>0){const g=d.getRangeAt(0);let{startContainer:u,startOffset:h}=g;if(u.nodeType!==Node.TEXT_NODE&&u.childNodes.length>0){const f=Math.min(h,u.childNodes.length-1),b=u.childNodes[f];b&&b.nodeType===Node.TEXT_NODE&&(u=b,h=b.textContent?.length||0)}if(u.nodeType===Node.TEXT_NODE){const f=u;if((f.textContent||"").substring(0,h).endsWith(e)){const w=document.createRange();w.setStart(f,h-e.length),w.setEnd(f,h),d.removeAllRanges(),d.addRange(w),document.execCommand("delete",!1),await this.delay(100)}}}l++,o=this.getElementText(t)}return o.endsWith(e)?(this.log("Deletion failed after retries"),!1):(await this.delay(50),i&&i.length>0&&a&&a.length>0?await this.replaceWithChunks(t,i,a,e,n):document.execCommand("insertText",!1,n)?(s!==void 0&&s<n.length&&await this.setCursorPosition(t,s,n),await this.delay(200),this.verify(t,n,e)):(this.log("insertText failed"),!1))}async replaceWithChunks(t,e,n,s,i){this.log(`Replacing with ${e.length} chunks and ${n.length} actions`);for(let a=0;a<e.length;a++){if(!document.execCommand("insertText",!1,e[a]))return this.log(`Failed to insert chunk ${a}`),!1;await this.delay(100),a<n.length&&(await this.executeKeyboardAction(t,n[a]),await this.delay(100))}return await this.delay(200),this.verify(t,i,s)}async setCursorPosition(t,e,n){this.log(`Setting cursor position to offset ${e}`);const s=window.getSelection();if(!(!s||s.rangeCount===0))try{const i=s.getRangeAt(0),{startContainer:a}=i;if(a.nodeType===Node.TEXT_NODE){const r=a,l=r.textContent||"",o=l.length-(n.length-e);o>=0&&o<=l.length&&(i.setStart(r,o),i.setEnd(r,o),s.removeAllRanges(),s.addRange(i))}}catch(i){this.log("Failed to set cursor position:",i)}}}class $ extends m{constructor(){super(...arguments),this.name="React",this.priority=5}canHandle(t){return H.isReact(t)&&(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)}async replace(t,e,n,s,i,a){if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement))return!1;this.log("Starting React-specific replacement");const r=t.value,l=t.selectionStart??r.length;let o=-1,c=-1;if(r.substring(0,l).endsWith(e)?(o=l-e.length,c=l):r.endsWith(e)?(o=r.length-e.length,c=r.length):(o=r.lastIndexOf(e),o!==-1&&(c=o+e.length)),o===-1)return this.log("Trigger not found"),!1;const g=r.substring(0,o),u=r.substring(c);if(i&&i.length>0&&a&&a.length>0)return await this.replaceWithChunks(t,g,u,i,a,e,n);const h=g+n+u,f=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set,b=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;t instanceof HTMLInputElement&&f?f.call(t,h):t instanceof HTMLTextAreaElement&&b?b.call(t,h):t.value=h;const E=t._valueTracker;E&&E.setValue(""),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}));const w=g.length+(s??n.length);try{t.setSelectionRange(w,w)}catch{}return await this.delay(10),this.verify(t,n,e)}async replaceWithChunks(t,e,n,s,i,a,r){this.log(`Replacing with ${s.length} chunks and ${i.length} actions`);const l=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set,o=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;let c=e;for(let d=0;d<s.length;d++){c+=s[d];const g=c+n;t instanceof HTMLInputElement&&l?l.call(t,g):t instanceof HTMLTextAreaElement&&o?o.call(t,g):t.value=g;const u=t._valueTracker;u&&u.setValue(""),t.dispatchEvent(new Event("input",{bubbles:!0}));const h=c.length;try{t.setSelectionRange(h,h)}catch{}d<i.length&&await this.executeKeyboardAction(t,i[d])}return t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(10),this.verify(t,r,a)}}class A extends m{constructor(){super(...arguments),this.name="ContentEditable",this.priority=3}canHandle(t){return t.isContentEditable}async replace(t,e,n,s,i,a){this.log("Starting contenteditable replacement");const r=window.getSelection();if(!r||r.rangeCount===0)return this.log("No selection available"),!1;const l=r.getRangeAt(0);let{startContainer:o,startOffset:c}=l;if(o.nodeType!==Node.TEXT_NODE)if(o.childNodes.length>0){const w=Math.min(c,o.childNodes.length-1),y=o.childNodes[w];if(y&&y.nodeType===Node.TEXT_NODE)o=y,c=y.textContent?.length||0;else return this.log("Could not find text node"),!1}else return this.log("No child nodes"),!1;const d=o;if(!(d.textContent||"").substring(0,c).endsWith(e))return this.log("Trigger not found before cursor"),!1;const h=document.createRange(),f=c-e.length;return h.setStart(d,f),h.setEnd(d,c),r.removeAllRanges(),r.addRange(h),document.execCommand("delete",!1)?i&&i.length>0&&a&&a.length>0?await this.replaceWithChunks(t,i,a,e,n):document.execCommand("insertText",!1,n)?(s!==void 0&&s<n.length&&await this.setCursorPosition(t,s,n),t.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(10),this.verify(t,n,e)):(this.log("InsertText command failed"),!1):(this.log("Delete command failed"),!1)}async replaceWithChunks(t,e,n,s,i){this.log(`Replacing with ${e.length} chunks and ${n.length} actions`);for(let a=0;a<e.length;a++){if(!document.execCommand("insertText",!1,e[a]))return this.log(`Failed to insert chunk ${a}`),!1;t.dispatchEvent(new Event("input",{bubbles:!0})),a<n.length&&await this.executeKeyboardAction(t,n[a])}return await this.delay(10),this.verify(t,i,s)}async setCursorPosition(t,e,n){this.log(`Setting cursor position to offset ${e}`);const s=window.getSelection();if(!(!s||s.rangeCount===0))try{const i=s.getRangeAt(0),{startContainer:a}=i;if(a.nodeType===Node.TEXT_NODE){const r=a,l=r.textContent||"",o=l.length-(n.length-e);o>=0&&o<=l.length&&(i.setStart(r,o),i.setEnd(r,o),s.removeAllRanges(),s.addRange(i))}}catch(i){this.log("Failed to set cursor position:",i)}}}class I extends m{constructor(){super(...arguments),this.name="Standard",this.priority=1}canHandle(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement}async replace(t,e,n,s,i,a){if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement))return!1;this.log("Starting standard replacement");const r=t.value,l=t.selectionStart??r.length,o=this.findTrigger(r.substring(0,l),e);if(!o)return this.log("Trigger not found"),!1;const c=r.substring(0,o.start),d=r.substring(l);if(i&&i.length>0&&a&&a.length>0)return await this.replaceWithChunks(t,c,d,i,a,e,n);const g=c+n+d;t.value=g;const u=c.length+(s??n.length);try{t.setSelectionRange(u,u)}catch{}return t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(10),this.verify(t,n,e)}async replaceWithChunks(t,e,n,s,i,a,r){this.log(`Replacing with ${s.length} chunks and ${i.length} actions`);let l=e;for(let o=0;o<s.length;o++){l+=s[o],t.value=l+n,t.dispatchEvent(new Event("input",{bubbles:!0}));const c=l.length;try{t.setSelectionRange(c,c)}catch{}o<i.length&&await this.executeKeyboardAction(t,i[o])}return t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(10),this.verify(t,r,a)}}class R{constructor(){this.handlers=[],this.debugMode=!1,this.register(new L),this.register(new $),this.register(new A),this.register(new I),this.handlers.sort((t,e)=>e.priority-t.priority)}register(t){this.handlers.push(t)}setDebugMode(t){this.debugMode=t,this.handlers.forEach(e=>{"setDebugMode"in e&&e.setDebugMode(t)})}getHandler(t){for(const e of this.handlers)if(e.canHandle(t))return this.debugMode&&console.log(`TextBlitz: Selected handler: ${e.name}`),e;return null}getHandlerChain(t){return this.handlers.filter(e=>e.canHandle(t))}listHandlers(){return this.handlers.map(t=>`${t.name} (priority: ${t.priority})`)}}const C=class C{static setDebugMode(t){this.debugMode=t,this.registry.setDebugMode(t),p.setDebugMode(t)}static log(...t){this.debugMode&&console.log("TextBlitz [Replacer]:",...t)}static async replace(t,e,n,s,i){const a=i||e,r={element:p.getElementContext(t),site:p.getSiteContext(),snippet:{trigger:e}};try{if(p.info("expansion","Starting replacement",r),!document.contains(t))return p.warn("expansion","Element not in document",r),!1;let l=await M.processCommands(n);s&&s!=="none"&&(l=D.transform(l,s,e));const o="{cursor}";let c;const d=l.lastIndexOf(o);if(d!==-1){const T=(l.match(/\{cursor\}/g)||[]).length;l=l.replace(/\{cursor\}/g,""),c=d-o.length*(T-1),this.log(`Cursor position: ${c} (removed ${T} markers)`)}const{chunks:g,actions:u}=M.splitTextByKeyboardActions(l),h=g.join("");this.log("Final expansion:",h),g.length>1&&this.log(`Split into ${g.length} chunks with ${u.length} actions`);const f=this.registry.getHandler(t);if(!f)return p.error("expansion","No handler available for element",r),!1;p.info("handler",`Using ${f.name} handler`,r);const b=this.getElementText(t),E=g.length>1&&u.length>0;if(await f.replace(t,a,h,c,E?g:void 0,E?u:void 0))return p.info("success",`${f.name} handler succeeded`,r),!0;p.warn("handler",`${f.name} handler failed, trying fallback chain`,r);const y=this.registry.getHandlerChain(t);for(const T of y){if(T===f)continue;if(p.info("fallback",`Trying fallback: ${T.name}`,r),await T.replace(t,a,h,c,E?g:void 0,E?u:void 0))return p.info("success",`Fallback ${T.name} succeeded`,r),!0}return p.error("fail","All handlers failed, rolling back",r),this.rollback(t,b),!1}catch(l){const o={...r,error:l instanceof Error?l.message:String(l)};return p.error("fail","Fatal error in replace",o),console.error("TextBlitz: Fatal error:",l),!1}}static getElementText(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value:t.textContent||""}static rollback(t,e){try{t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0}))):t.isContentEditable&&(t.textContent=e,t.dispatchEvent(new Event("input",{bubbles:!0}))),this.log("Rolled back to previous content")}catch(n){console.error("TextBlitz: Rollback failed:",n)}}static isValidInputElement(t){return t instanceof HTMLInputElement&&t.type==="password"||t instanceof HTMLInputElement&&t.type==="hidden"||t instanceof HTMLInputElement&&["number","date","time","color","range","file","datetime-local","month","week"].includes(t.type)?!1:t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t.isContentEditable}static listHandlers(){return this.registry.listHandlers()}};C.debugMode=!1,C.registry=new R;let S=C;export{S as TextReplacer};
