import{C as M,a as $}from"./case-transform.js";class v{constructor(){this.logs=[],this.debugMode=!1,this.maxLogs=100,this.sessionId=`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static getInstance(){return v.instance||(v.instance=new v),v.instance}setDebugMode(t){this.debugMode=t}addLog(t){t.context||(t.context={}),t.context.sessionId=this.sessionId,this.logs.push(t),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs))}info(t,e,n){const s={level:"info",category:t,message:e,context:n,timestamp:Date.now()};this.addLog(s),this.debugMode&&console.log(`TextBlitz [${t}]:`,e,n||"")}warn(t,e,n){const s={level:"warn",category:t,message:e,context:n,timestamp:Date.now()};this.addLog(s),this.debugMode&&console.warn(`TextBlitz [${t}]:`,e,n||"")}error(t,e,n){const s={level:"error",category:t,message:e,context:n,timestamp:Date.now()};this.addLog(s),console.error(`TextBlitz [${t}]:`,e,n||"")}debug(t,e,n){const s={level:"debug",category:t,message:e,context:n,timestamp:Date.now()};this.addLog(s),this.debugMode&&console.log(`TextBlitz [${t}] DEBUG:`,e,n||"")}getElementContext(t){return{tag:t.tagName,type:t instanceof HTMLInputElement?t.type:void 0,id:t.id||void 0,classes:t.className||void 0,contentEditable:t.isContentEditable}}getSiteContext(){return{hostname:window.location.hostname,url:window.location.href}}getRecentLogs(t=50){return this.logs.slice(-t)}getLogsByCategory(t){return this.logs.filter(e=>e.category===t)}getErrors(){return this.logs.filter(t=>t.level==="error")}formatForGitHub(){const t=this.getErrors(),e=this.getRecentLogs(20);let n=`## TextBlitz Error Report

`;return n+=`**Session ID:** ${this.sessionId}
`,n+=`**Timestamp:** ${new Date().toISOString()}
`,n+=`**Site:** ${window.location.hostname}
`,n+=`**User Agent:** ${navigator.userAgent}

`,t.length>0&&(n+=`### Errors

`,t.forEach(s=>{n+=`- **${s.category}** (${new Date(s.timestamp).toISOString()}): ${s.message}
`,s.context&&(n+=`  \`\`\`json
  ${JSON.stringify(s.context,null,2)}
  \`\`\`
`)}),n+=`
`),n+=`### Recent Activity (Last 20 events)

`,n+="```\n",e.forEach(s=>{const i=new Date(s.timestamp).toISOString().split("T")[1].split(".")[0];n+=`[${i}] ${s.level.toUpperCase()} ${s.category}: ${s.message}
`}),n+="```\n",n}clearLogs(){this.logs=[]}}const p=v.getInstance();class m{constructor(){this.debugMode=!1}setDebugMode(t){this.debugMode=t}log(...t){this.debugMode&&console.log(`[${this.name}]`,...t)}async delay(t){return new Promise(e=>setTimeout(e,t))}getElementText(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value:t.textContent||""}findTrigger(t,e){if(t.endsWith(e))return{start:t.length-e.length,end:t.length};const n=t.lastIndexOf(e);return n!==-1?{start:n,end:n+e.length}:null}verify(t,e,n){const s=this.getElementText(t),i=e.substring(0,Math.min(10,e.length));return s.includes(i)?s.endsWith(n)?(this.log("Verification failed: trigger still present"),!1):!0:(this.log("Verification failed: expansion not found"),!1)}async executeKeyboardAction(t,e){switch(e.type){case"enter":await this.executeEnter(t);break;case"tab":await this.executeTab(t);break;case"delay":await this.executeDelay(e.options);break}}async executeEnter(t){if(this.log("Executing {enter}"),t instanceof HTMLTextAreaElement||t.isContentEditable){const e=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,bubbles:!0,cancelable:!0});t.dispatchEvent(e)}else if(t instanceof HTMLInputElement){const e=t.form;e?e.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0})):t.blur()}}async executeTab(t){this.log("Executing {tab}");const e=Array.from(document.querySelectorAll('input:not([disabled]):not([type="hidden"]), textarea:not([disabled]), select:not([disabled]), button:not([disabled]), [contenteditable="true"], [tabindex]:not([tabindex="-1"])')),n=e.indexOf(t);n!==-1&&n<e.length-1&&e[n+1].focus()}async executeDelay(t){let n=1e3;if(t){const s=t.match(/\+?(\d+(?:\.\d+)?)(s|ms)?/);if(s){const i=parseFloat(s[1]);n=(s[2]||"s")==="ms"?i:i*1e3}}this.log(`Executing {delay} for ${n}ms`),await this.delay(n)}}class H{static isGoogleDocs(t){return!!(window.location.hostname.includes("docs.google.com")||t&&(t.classList.contains("kix-cursor")||t.closest(".kix-appview-editor")||document.querySelector(".kix-appview-editor")))}static isReact(t){return Object.keys(t).some(n=>n.startsWith("__react")||n.startsWith("_react")||n.startsWith("__REACT"))}static isVue(t){return"__vue__"in t||"__vueParentComponent"in t||"__v_skip"in t}static isShadowDOM(t){return!!t.shadowRoot||!!t.closest("[shadowroot]")}static isCustomEditor(t){return t.classList.contains("CodeMirror")||t.classList.contains("monaco-editor")||t.getAttribute("data-lexical-editor")!==null||t.classList.contains("ProseMirror")}static getSiteType(t){return this.isGoogleDocs(t)?"google-docs":this.isCustomEditor(t)?"custom-editor":this.isReact(t)?"react":this.isVue(t)?"vue":this.isShadowDOM(t)?"shadow-dom":"standard"}}class D extends m{constructor(){super(...arguments),this.name="GoogleDocs",this.priority=10}canHandle(t){return H.isGoogleDocs(t)}async replace(t,e,n,s,i,l){if(this.log("Starting Google Docs replacement"),t.focus(),await this.delay(50),!this.getElementText(t).endsWith(e))return this.log("Trigger not found at end of text"),!1;for(let h=0;h<e.length;h++)document.execCommand("delete",!1);await this.delay(100);let o=0,a=this.getElementText(t);for(;a.endsWith(e)&&o<3;){this.log(`Deletion retry ${o+1}/3`);const h=window.getSelection();if(h&&h.rangeCount>0){const d=h.getRangeAt(0);let{startContainer:u,startOffset:g}=d;if(u.nodeType!==Node.TEXT_NODE&&u.childNodes.length>0){const f=Math.min(g,u.childNodes.length-1),b=u.childNodes[f];b&&b.nodeType===Node.TEXT_NODE&&(u=b,g=b.textContent?.length||0)}if(u.nodeType===Node.TEXT_NODE){const f=u;if((f.textContent||"").substring(0,g).endsWith(e)){const w=document.createRange();w.setStart(f,g-e.length),w.setEnd(f,g),h.removeAllRanges(),h.addRange(w),document.execCommand("delete",!1),await this.delay(100)}}}o++,a=this.getElementText(t)}return a.endsWith(e)?(this.log("Deletion failed after retries"),!1):(await this.delay(50),i&&i.length>0&&l&&l.length>0?await this.replaceWithChunks(t,i,l,e,n):document.execCommand("insertText",!1,n)?(s!==void 0&&s<n.length&&await this.setCursorPosition(t,s,n),await this.delay(200),this.verify(t,n,e)):(this.log("insertText failed"),!1))}async replaceWithChunks(t,e,n,s,i){this.log(`Replacing with ${e.length} chunks and ${n.length} actions`);for(let l=0;l<e.length;l++){if(!document.execCommand("insertText",!1,e[l]))return this.log(`Failed to insert chunk ${l}`),!1;await this.delay(100),l<n.length&&(await this.executeKeyboardAction(t,n[l]),await this.delay(100))}return await this.delay(200),this.verify(t,i,s)}async setCursorPosition(t,e,n){this.log(`Setting cursor position to offset ${e}`);const s=window.getSelection();if(!(!s||s.rangeCount===0))try{const i=s.getRangeAt(0),{startContainer:l}=i;if(l.nodeType===Node.TEXT_NODE){const r=l,o=r.textContent||"",a=o.length-(n.length-e);a>=0&&a<=o.length&&(i.setStart(r,a),i.setEnd(r,a),s.removeAllRanges(),s.addRange(i))}}catch(i){this.log("Failed to set cursor position:",i)}}}class L extends m{constructor(){super(...arguments),this.name="React",this.priority=5}canHandle(t){return H.isReact(t)&&(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)}async replace(t,e,n,s,i,l){if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement))return!1;this.log("Starting React-specific replacement");const r=t.value,o=t.selectionStart??r.length;let a=-1,c=-1;if(r.substring(0,o).endsWith(e)?(a=o-e.length,c=o):r.endsWith(e)?(a=r.length-e.length,c=r.length):(a=r.lastIndexOf(e),a!==-1&&(c=a+e.length)),a===-1)return this.log("Trigger not found"),!1;const d=r.substring(0,a),u=r.substring(c);if(i&&i.length>0&&l&&l.length>0)return await this.replaceWithChunks(t,d,u,i,l,e,n,s);const g=d+n+u,f=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set,b=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;t instanceof HTMLInputElement&&f?f.call(t,g):t instanceof HTMLTextAreaElement&&b?b.call(t,g):t.value=g;const y=t._valueTracker;y&&y.setValue(""),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}));const w=d.length+(s??n.length);try{t.setSelectionRange(w,w)}catch{}return await this.delay(10),this.verify(t,n,e)}async replaceWithChunks(t,e,n,s,i,l,r,o){this.log(`Replacing with ${s.length} chunks and ${i.length} actions`);const a=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set,c=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;let h=e;for(let d=0;d<s.length;d++){if(s[d].length===0&&d<s.length-1){d<i.length&&await this.executeKeyboardAction(t,i[d]);continue}h+=s[d];const u=h+n;t instanceof HTMLInputElement&&a?a.call(t,u):t instanceof HTMLTextAreaElement&&c?c.call(t,u):t.value=u;const g=t._valueTracker;g&&g.setValue(""),t.dispatchEvent(new Event("input",{bubbles:!0}));const f=h.length;try{t.setSelectionRange(f,f)}catch{}d<i.length&&await this.executeKeyboardAction(t,i[d])}if(o!==void 0){const d=e.length+o;try{t.setSelectionRange(d,d),this.log(`Set cursor to offset ${o} (absolute pos ${d})`)}catch(u){this.log("Failed to set cursor position:",u)}}return t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(10),this.verify(t,r,l)}}class A extends m{constructor(){super(...arguments),this.name="ContentEditable",this.priority=3}canHandle(t){return t.isContentEditable}async replace(t,e,n,s,i,l){this.log("Starting contenteditable replacement");const r=window.getSelection();if(!r||r.rangeCount===0)return this.log("No selection available"),!1;const o=r.getRangeAt(0);let{startContainer:a,startOffset:c}=o;if(a.nodeType!==Node.TEXT_NODE)if(a.childNodes.length>0){const w=Math.min(c,a.childNodes.length-1),E=a.childNodes[w];if(E&&E.nodeType===Node.TEXT_NODE)a=E,c=E.textContent?.length||0;else return this.log("Could not find text node"),!1}else return this.log("No child nodes"),!1;const h=a;if(!(h.textContent||"").substring(0,c).endsWith(e))return this.log("Trigger not found before cursor"),!1;const g=document.createRange(),f=c-e.length;return g.setStart(h,f),g.setEnd(h,c),r.removeAllRanges(),r.addRange(g),document.execCommand("delete",!1)?i&&i.length>0&&l&&l.length>0?await this.replaceWithChunks(t,i,l,e,n,s):document.execCommand("insertText",!1,n)?(s!==void 0&&s<n.length&&await this.setCursorPosition(t,s,n),t.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(10),this.verify(t,n,e)):(this.log("InsertText command failed"),!1):(this.log("Delete command failed"),!1)}async replaceWithChunks(t,e,n,s,i,l){this.log(`Replacing with ${e.length} chunks and ${n.length} actions`);let r=0;for(let o=0;o<e.length;o++){if(e[o].length===0&&o<e.length-1){o<n.length&&await this.executeKeyboardAction(t,n[o]);continue}if(!document.execCommand("insertText",!1,e[o]))return this.log(`Failed to insert chunk ${o}`),!1;r+=e[o].length,t.dispatchEvent(new Event("input",{bubbles:!0})),o<n.length&&await this.executeKeyboardAction(t,n[o])}return l!==void 0&&l<r&&await this.setCursorFromEnd(t,r-l),await this.delay(10),this.verify(t,i,s)}async setCursorFromEnd(t,e){const n=window.getSelection();if(!(!n||n.rangeCount===0))try{const s=n.getRangeAt(0),{startContainer:i,startOffset:l}=s;if(i.nodeType===Node.TEXT_NODE){const r=i,o=Math.max(0,l-e);s.setStart(r,o),s.setEnd(r,o),n.removeAllRanges(),n.addRange(s),this.log(`Moved cursor back ${e} chars to position ${o}`)}}catch(s){this.log("Failed to move cursor:",s)}}async setCursorPosition(t,e,n){this.log(`Setting cursor position to offset ${e}`);const s=window.getSelection();if(!(!s||s.rangeCount===0))try{const i=s.getRangeAt(0),{startContainer:l}=i;if(l.nodeType===Node.TEXT_NODE){const r=l,o=r.textContent||"",a=o.length-(n.length-e);a>=0&&a<=o.length&&(i.setStart(r,a),i.setEnd(r,a),s.removeAllRanges(),s.addRange(i))}}catch(i){this.log("Failed to set cursor position:",i)}}}class R extends m{constructor(){super(...arguments),this.name="Standard",this.priority=1}canHandle(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement}async replace(t,e,n,s,i,l){if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement))return!1;this.log("Starting standard replacement");const r=t.value,o=t.selectionStart??r.length,a=this.findTrigger(r.substring(0,o),e);if(!a)return this.log("Trigger not found"),!1;const c=r.substring(0,a.start),h=r.substring(o);if(i&&i.length>0&&l&&l.length>0)return await this.replaceWithChunks(t,c,h,i,l,e,n,s);const d=c+n+h;t.value=d;const u=c.length+(s??n.length);try{t.setSelectionRange(u,u)}catch{}return t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(10),this.verify(t,n,e)}async replaceWithChunks(t,e,n,s,i,l,r,o){this.log(`Replacing with ${s.length} chunks and ${i.length} actions`);let a=e;for(let c=0;c<s.length;c++){if(s[c].length===0&&c<s.length-1){c<i.length&&await this.executeKeyboardAction(t,i[c]);continue}a+=s[c],t.value=a+n,t.dispatchEvent(new Event("input",{bubbles:!0}));const h=a.length;try{t.setSelectionRange(h,h)}catch{}c<i.length&&await this.executeKeyboardAction(t,i[c])}if(o!==void 0){const c=e.length+o;try{t.setSelectionRange(c,c),this.log(`Set cursor to offset ${o} (absolute pos ${c})`)}catch(h){this.log("Failed to set cursor position:",h)}}return t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(10),this.verify(t,r,l)}}class I{constructor(){this.handlers=[],this.debugMode=!1,this.register(new D),this.register(new L),this.register(new A),this.register(new R),this.handlers.sort((t,e)=>e.priority-t.priority)}register(t){this.handlers.push(t)}setDebugMode(t){this.debugMode=t,this.handlers.forEach(e=>{"setDebugMode"in e&&e.setDebugMode(t)})}getHandler(t){for(const e of this.handlers)if(e.canHandle(t))return this.debugMode&&console.log(`TextBlitz: Selected handler: ${e.name}`),e;return null}getHandlerChain(t){return this.handlers.filter(e=>e.canHandle(t))}listHandlers(){return this.handlers.map(t=>`${t.name} (priority: ${t.priority})`)}}const C=class C{static setDebugMode(t){this.debugMode=t,this.registry.setDebugMode(t),p.setDebugMode(t)}static log(...t){this.debugMode&&console.log("TextBlitz [Replacer]:",...t)}static async replace(t,e,n,s,i){const l=i||e,r={element:p.getElementContext(t),site:p.getSiteContext(),snippet:{trigger:e}};try{if(p.info("expansion","Starting replacement",r),!document.contains(t))return p.warn("expansion","Element not in document",r),!1;let o=await M.processCommands(n);s&&s!=="none"&&(o=$.transform(o,s,e));const a="{cursor}";let c;const h=o.lastIndexOf(a);if(h!==-1){const x=(o.match(/\{cursor\}/g)||[]).length;o=o.replace(/\{cursor\}/g,""),c=h-a.length*(x-1),this.log(`Cursor position: ${c} (removed ${x} markers)`)}const{chunks:d,actions:u}=M.splitTextByKeyboardActions(o),g=d.join("");this.log("Final expansion:",g),d.length>1&&this.log(`Split into ${d.length} chunks with ${u.length} actions`);const f=this.registry.getHandler(t);if(!f)return p.error("expansion","No handler available for element",r),!1;p.info("handler",`Using ${f.name} handler`,r);const b=this.getElementText(t),y=d.length>1&&u.length>0;if(await f.replace(t,l,g,c,y?d:void 0,y?u:void 0))return p.info("success",`${f.name} handler succeeded`,r),!0;p.warn("handler",`${f.name} handler failed, trying fallback chain`,r);const E=this.registry.getHandlerChain(t);for(const x of E){if(x===f)continue;if(p.info("fallback",`Trying fallback: ${x.name}`,r),await x.replace(t,l,g,c,y?d:void 0,y?u:void 0))return p.info("success",`Fallback ${x.name} succeeded`,r),!0}return p.error("fail","All handlers failed, rolling back",r),this.rollback(t,b),!1}catch(o){const a={...r,error:o instanceof Error?o.message:String(o)};return p.error("fail","Fatal error in replace",a),console.error("TextBlitz: Fatal error:",o),!1}}static getElementText(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value:t.textContent||""}static rollback(t,e){try{t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0}))):t.isContentEditable&&(t.textContent=e,t.dispatchEvent(new Event("input",{bubbles:!0}))),this.log("Rolled back to previous content")}catch(n){console.error("TextBlitz: Rollback failed:",n)}}static isValidInputElement(t){return t instanceof HTMLInputElement&&t.type==="password"||t instanceof HTMLInputElement&&t.type==="hidden"||t instanceof HTMLInputElement&&["number","date","time","color","range","file","datetime-local","month","week"].includes(t.type)?!1:t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t.isContentEditable}static listHandlers(){return this.registry.listHandlers()}};C.debugMode=!1,C.registry=new I;let S=C;export{S as TextReplacer};
