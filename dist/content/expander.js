(function(){"use strict";const C={enabled:!0,delimiter:" ",expandOnDelimiter:!0,caseSensitive:!1,debugMode:!1,darkMode:"system",customFolders:[],llmKeys:{},llmDefaultProvider:"groq",llmTimeout:5e3,llmMaxTokens:100,llmSystemPrompt:"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",llmUsageAlert:80,llmModels:{groq:"llama-3.3-70b-versatile",openai:"gpt-4o-mini",anthropic:"claude-sonnet-4-20250514",gemini:"gemini-2.0-flash-exp"},llmTiers:{groq:"free",openai:"tier1",anthropic:"tier1",gemini:"free"}},k=class k{static async initialize(){if(this.initialized){console.log("StorageManager: Already initialized, skipping");return}if(this.initialized=!0,console.log("StorageManager: Starting initialization..."),typeof chrome>"u")throw new Error("chrome API is not available");if(!chrome.storage)throw new Error("chrome.storage API is not available");if(!chrome.storage.local)throw new Error("chrome.storage.local API is not available");console.log("StorageManager: ✅ chrome.storage.local is available");try{console.log("StorageManager: Getting data with 5000ms timeout...");const e=await Promise.race([chrome.storage.local.get(["snippets","settings"]),new Promise((i,o)=>setTimeout(()=>o(new Error("Storage get timed out after 5000ms")),5e3))]),s=e.snippets||{};let n=!1;for(const i of Object.values(s))i.triggerMode||(i.triggerMode="word",n=!0,console.log("StorageManager: Added default triggerMode to snippet",i.id)),i.label||(i.label=i.trigger,n=!0,console.log("StorageManager: Added default label to snippet",i.id));this.snippetCache=s,this.settingsCache={...C,...e.settings},n&&(console.log("StorageManager: Updating snippets with triggerMode"),await chrome.storage.local.set({snippets:this.snippetCache})),console.log("StorageManager: Loaded",Object.keys(this.snippetCache).length,"snippets"),(!e.settings||JSON.stringify(Object.keys(e.settings))!==JSON.stringify(Object.keys(C)))&&(console.log("StorageManager: Updating settings with new fields"),await chrome.storage.local.set({settings:this.settingsCache})),chrome.storage.onChanged.addListener((i,o)=>{o==="local"&&(i.snippets&&(this.snippetCache=i.snippets.newValue||{},console.log("StorageManager: Snippets updated from external change")),i.settings&&(this.settingsCache=i.settings.newValue||C,console.log("StorageManager: Settings updated from external change")))}),console.log("StorageManager: ✅ Initialized successfully")}catch(t){throw this.initialized=!1,console.error("StorageManager: ❌ Failed to initialize:",t),t}}static async getSnippets(){return this.initialized||await this.initialize(),this.snippetCache}static async getSnippet(t){return this.initialized||await this.initialize(),this.snippetCache[t]}static async saveSnippet(t){this.initialized||await this.initialize(),this.snippetCache[t.id]=t,await chrome.storage.local.set({snippets:this.snippetCache})}static async deleteSnippet(t){this.initialized||await this.initialize(),delete this.snippetCache[t],await chrome.storage.local.set({snippets:this.snippetCache})}static async getSettings(){return this.initialized||await this.initialize(),this.settingsCache}static async saveSettings(t){this.initialized||await this.initialize(),this.settingsCache=t,await chrome.storage.local.set({settings:t})}static async incrementUsage(t){this.initialized||await this.initialize();const e=this.snippetCache[t];e&&(e.usageCount++,e.lastUsed=Date.now(),await this.saveSnippet(e))}static async exportData(){return this.initialized||await this.initialize(),{snippets:this.snippetCache,settings:this.settingsCache}}static async importData(t){this.initialized||await this.initialize(),t.snippets&&(this.snippetCache={...this.snippetCache,...t.snippets},await chrome.storage.local.set({snippets:this.snippetCache})),t.settings&&(this.settingsCache={...this.settingsCache,...t.settings},await chrome.storage.local.set({settings:this.settingsCache}))}};k.snippetCache={},k.settingsCache=C,k.initialized=!1;let g=k;class S{constructor(){this.children=new Map,this.snippet=null,this.isEndOfWord=!1}}class A{constructor(t=!1){this.root=new S,this.caseSensitive=t}normalizeKey(t){return this.caseSensitive?t:t.toLowerCase()}insert(t){if(!t.enabled)return;const e=this.caseSensitive?t.trigger:t.trigger.toLowerCase();let s=this.root;for(const n of e){const i=this.normalizeKey(n);s.children.has(i)||s.children.set(i,new S),s=s.children.get(i)}s.isEndOfWord=!0,s.snippet=t}search(t){const e=this.caseSensitive?t:t.toLowerCase();let s=this.root;for(const n of e){const i=this.normalizeKey(n);if(!s.children.has(i))return null;s=s.children.get(i)}return s.isEndOfWord?s.snippet:null}findMatch(t){if(t.length===0)return null;for(let e=0;e<=t.length;e++){const s=t.substring(e).trim();if(s.length===0)continue;const n=this.search(s);if(n)return{snippet:n,matchLength:s.length}}return null}rebuild(t){this.root=new S,Object.values(t).forEach(e=>this.insert(e))}clear(){this.root=new S}}const v=class v{static parse(t){const e=[],s=new RegExp(this.COMMAND_REGEX);let n;for(;(n=s.exec(t))!==null;){const[i,o,r]=n;e.push({type:o,options:r?.trim()||void 0,startIndex:n.index,endIndex:n.index+i.length,rawMatch:i})}return e}static parseFormCommands(t){const e=[],s=new RegExp(this.FORM_COMMAND_REGEX);let n;for(;(n=s.exec(t))!==null;){const[i,o,r]=n,a=this.parseFormField(o,r);a&&e.push({type:"form",options:r,startIndex:n.index,endIndex:n.index+i.length,rawMatch:i,formField:a})}return e}static parseFormField(t,e){const s=e.split(";").map(a=>a.trim()),n={};for(const a of s){const[l,c]=a.split("=").map(u=>u.trim());l&&c&&(n[l]=c)}const i=n.label||n.name||"Field",o=n.name||i.toLowerCase().replace(/\s+/g,"_"),r={type:t.replace("form",""),name:o,label:i,required:n.required==="true"};return t==="formmenu"&&n.options&&(r.options=n.options.split(",").map(a=>a.trim())),n.default&&(r.defaultValue=t==="formtoggle"?n.default==="true":n.default),r}static hasFormCommands(t){return this.FORM_COMMAND_REGEX.test(t)}static extractFormFields(t){return this.parseFormCommands(t).map(s=>s.formField).filter(Boolean)}static getOrdinalSuffix(t){if(t>=11&&t<=13)return"th";switch(t%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}static parseDateShift(t){const e=t.match(/shift\s+([+-]?\d+)([dMY])/);if(!e)return null;const s=parseInt(e[1],10),n=e[2];return{value:s,unit:n}}static applyDateShift(t,e){const s=new Date(t);switch(e.unit){case"d":s.setDate(s.getDate()+e.value);break;case"M":s.setMonth(s.getMonth()+e.value);break;case"Y":s.setFullYear(s.getFullYear()+e.value);break}return s}static formatDate(t,e){let s=t,n=e||"YYYY-MM-DD";if(e){const u=this.parseDateShift(e);u&&(s=this.applyDateShift(t,u),n=e.replace(/\s*shift\s+[+-]?\d+[dMY]\s*/,"").trim()||"YYYY-MM-DD")}const i=s.getFullYear(),o=String(s.getMonth()+1).padStart(2,"0"),r=s.getDate(),a=String(r).padStart(2,"0"),l=s.toLocaleDateString("en-US",{month:"long"}),c=s.toLocaleDateString("en-US",{month:"short"});return n.replace("YYYY",String(i)).replace("YY",String(i).slice(-2)).replace("MMMM",l).replace("MMM",c).replace("Do",`${r}${this.getOrdinalSuffix(r)}`).replace("MM",o).replace("M",String(s.getMonth()+1)).replace("DD",a).replace("D",String(r))}static formatTime(t,e){const n=e||"HH:mm",i=t.getHours(),o=i%12||12,r=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0"),l=i>=12?"PM":"AM";return n==="12h"?`${o}:${r} ${l}`:n==="24h"?`${String(i).padStart(2,"0")}:${r}`:n.replace("HH",String(i).padStart(2,"0")).replace("H",String(i)).replace("hh",String(o).padStart(2,"0")).replace("h",String(o)).replace("mm",r).replace("ss",a).replace("A",l).replace("a",l.toLowerCase())}static parseDelayMs(t){if(!t)return 0;const e=t.match(/\+?(\d+(?:\.\d+)?)(s|ms)?/);if(!e)return 0;const s=parseFloat(e[1]);return(e[2]||"s")==="ms"?s:s*1e3}static async processCommands(t){const e=this.parse(t);if(e.length===0)return t;let s=t;const n=new Date;for(let i=e.length-1;i>=0;i--){const o=e[i];let r;switch(o.type){case"date":r=this.formatDate(n,o.options);break;case"time":r=this.formatTime(n,o.options);break;case"clipboard":try{r=await navigator.clipboard.readText()}catch{console.warn("TextBlitz: Clipboard access denied or unavailable"),r=o.rawMatch}break;case"cursor":case"enter":case"tab":case"delay":continue;default:r=o.rawMatch}s=s.slice(0,o.startIndex)+r+s.slice(o.endIndex)}return s}static extractKeyboardActions(t){const e=this.parse(t),s=[];let n=t,i=0;for(const o of e)if(o.type==="enter"||o.type==="tab"||o.type==="delay"){const r=o.startIndex-i;s.push({type:o.type,options:o.options,position:r}),n=n.slice(0,o.startIndex-i)+n.slice(o.endIndex-i),i+=o.rawMatch.length}return{text:n,actions:s}}static splitTextByKeyboardActions(t){const s=this.parse(t).filter(r=>r.type==="enter"||r.type==="tab"||r.type==="delay");if(s.length===0)return{chunks:[t],actions:[]};const n=[],i=[];let o=0;for(const r of s)n.push(t.substring(o,r.startIndex)),i.push({type:r.type,options:r.options}),o=r.endIndex;return n.push(t.substring(o)),{chunks:n,actions:i}}static substituteFormValues(t,e){const s=this.parseFormCommands(t);if(s.length===0)return t;let n=t;for(let i=s.length-1;i>=0;i--){const o=s[i];if(o.formField){const r=e[o.formField.name],a=r!==void 0?String(r):"";n=n.slice(0,o.startIndex)+a+n.slice(o.endIndex)}}return n}};v.COMMAND_REGEX=/\{(date|time|clipboard|cursor|enter|tab|delay)(?:[\s:]([^}]+))?\}/g,v.FORM_COMMAND_REGEX=/\{(formtext|formparagraph|formmenu|formdate|formtoggle):([^}]+)\}/g;let m=v;class P{static detectCase(t){if(!t)return"lower";const e=/[a-z]/.test(t),s=/[A-Z]/.test(t);if(!e&&!s)return"lower";if(!e&&s)return"upper";if(e&&!s)return"lower";if(/^[A-Z]/.test(t)){const n=t.split(/\s+/),i=n.filter(o=>/^[A-Z]/.test(o));return i.length>1||n.length>1&&i.length===n.length?"title":"capitalize"}return"mixed"}static transform(t,e,s){switch(e){case"upper":return t.toUpperCase();case"lower":return t.toLowerCase();case"title":return this.toTitleCase(t);case"capitalize":return this.capitalize(t);case"match":return s?this.matchCase(t,s):t;case"none":default:return t}}static toTitleCase(t){return t.split(/(\s+)/).map(e=>/^\s+$/.test(e)?e:e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join("")}static capitalize(t){return t&&t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}static matchCase(t,e){switch(this.detectCase(e)){case"upper":return t.toUpperCase();case"lower":return t.toLowerCase();case"title":return this.toTitleCase(t);case"capitalize":return this.capitalize(t);default:return t}}}const O=class O{static setDebugMode(t){this.debugMode=t}static log(...t){this.debugMode&&console.log(...t)}static parseCursor(t){const e="{cursor}",s=t.indexOf(e);return s===-1?{text:t,cursorOffset:t.length}:{text:t.slice(0,s)+t.slice(s+e.length),cursorOffset:s}}static dispatchKey(t,e){const s={key:e,code:e==="Enter"?"Enter":e==="Tab"?"Tab":e,bubbles:!0,cancelable:!0};t.dispatchEvent(new KeyboardEvent("keydown",s)),t.dispatchEvent(new KeyboardEvent("keypress",s)),t.dispatchEvent(new KeyboardEvent("keyup",s))}static async executeKeyboardActions(t,e){for(const s of e)if(s.type==="delay"){const n=m.parseDelayMs(s.options);await new Promise(i=>setTimeout(i,n))}else s.type==="enter"?this.dispatchKey(t,"Enter"):s.type==="tab"&&this.dispatchKey(t,"Tab")}static async replaceInInput(t,e,s,n){try{this.log("TextBlitz: replaceInInput called"),this.log("TextBlitz: Element type:",t.tagName,t instanceof HTMLInputElement?`(input type="${t.type}")`:"(textarea)");const i=t.selectionStart??t.value.length,o=t.value;this.log("TextBlitz: Current value:",o,"cursor at:",i),this.log("TextBlitz: Trigger length:",e.length,"trigger:",e);const r=o.substring(0,i);if(this.log("TextBlitz: Text before cursor:",r),!r.endsWith(e))return console.error("TextBlitz: Trigger not found before cursor!"),console.error("TextBlitz: Expected to find:",e,"at end of:",r),!1;const a=o.substring(0,i-e.length),l=o.substring(i);this.log("TextBlitz: Before:",a,"| After:",l),this.log("TextBlitz: Replacing trigger:",e,"with:",s);let c=await m.processCommands(s);n&&n!=="none"&&(c=P.transform(c,n,e));const{text:u,cursorOffset:h}=this.parseCursor(c),{chunks:d,actions:w}=m.splitTextByKeyboardActions(u);let T=a,M=0,f=a.length+h;for(let y=0;y<d.length;y++){const q=d[y];T+=q,M+=q.length,t.value=T+l;const H=new Event("input",{bubbles:!0});if(t.dispatchEvent(H),y<w.length){const z=w[y];if(z.type==="delay"){const V=m.parseDelayMs(z.options);await new Promise(X=>setTimeout(X,V))}else z.type==="enter"?this.dispatchKey(t,"Enter"):z.type==="tab"&&this.dispatchKey(t,"Tab")}}try{t.setSelectionRange(f,f)}catch{}return this.log("TextBlitz: New value:",t.value),this.log("TextBlitz: ✅ Replacement successful"),!0}catch(i){return console.error("TextBlitz: Error replacing in input",i),!1}}static getTextBeforeCursor(){const t=window.getSelection();if(!t||t.rangeCount===0)return null;const e=t.getRangeAt(0),{startContainer:s,startOffset:n}=e;let i=s;for(;i&&i.nodeType!==Node.ELEMENT_NODE;)i=i.parentNode;if(!i||!i.isContentEditable){let u=s.parentElement;for(;u&&!u.isContentEditable;)u=u.parentElement;i=u}if(!i)return null;const o=[];let r=null,a=!1;const l=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,null);for(;l.nextNode();){const u=l.currentNode;if(u===s){o.push(u),r=u,a=!0;break}o.push(u)}if(!a||!r)return null;let c="";for(let u=0;u<o.length-1;u++)c+=o[u].textContent||"";return c+=(r.textContent||"").substring(0,n),{text:c,nodes:o,lastNode:r,offset:n}}static async replaceInContentEditable(t,e,s,n){try{this.log("TextBlitz: replaceInContentEditable called");const i=window.getSelection();if(!i||i.rangeCount===0)return this.log("TextBlitz: No selection available"),!1;const o=i.getRangeAt(0),{startContainer:r,startOffset:a}=o;if(r.nodeType===Node.TEXT_NODE){const d=r;if((d.textContent||"").substring(0,a).endsWith(e))return this.log("TextBlitz: Using simple text node replacement"),await this.replaceInSimpleTextNode(t,d,a,e,s,n)}this.log("TextBlitz: Trying multi-node replacement");const l=this.getTextBeforeCursor();if(!l)return this.log("TextBlitz: Could not get text before cursor"),!1;const{text:c,lastNode:u,offset:h}=l;return this.log("TextBlitz: Text before cursor:",c),c.endsWith(e)?(this.log("TextBlitz: Using execCommand approach"),await this.replaceWithExecCommand(t,u,h,e,s,n)):(this.log("TextBlitz: Trigger not found at end of text"),!1)}catch(i){return console.error("TextBlitz: Error replacing in contenteditable",i),!1}}static async replaceInSimpleTextNode(t,e,s,n,i,o){try{const r=e.textContent||"",a=s-n.length,l=r.substring(s);let c=await m.processCommands(i);o&&o!=="none"&&(c=P.transform(c,o,n));const{text:u,cursorOffset:h}=this.parseCursor(c),{chunks:d,actions:w}=m.splitTextByKeyboardActions(u);let T=r.substring(0,a);for(let f=0;f<d.length;f++){T+=d[f],e.textContent=T+l;const y=new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:d[f]});t.dispatchEvent(y),f<w.length&&await this.executeKeyboardAction(t,w[f])}const M=window.getSelection();if(M){const f=document.createRange(),y=a+h;f.setStart(e,Math.min(y,e.textContent?.length||0)),f.setEnd(e,Math.min(y,e.textContent?.length||0)),M.removeAllRanges(),M.addRange(f)}return!0}catch(r){return this.log("TextBlitz: Error in simple text node replacement",r),!1}}static async replaceWithExecCommand(t,e,s,n,i,o){try{let r=await m.processCommands(i);o&&o!=="none"&&(r=P.transform(r,o,n));const{text:a,cursorOffset:l}=this.parseCursor(r),{chunks:c}=m.splitTextByKeyboardActions(a),u=c.join(""),h=window.getSelection();if(!h)return!1;const d=document.createRange(),w=(e.textContent||"").substring(0,s),T=s-n.length;d.setStart(e,T),d.setEnd(e,s),h.removeAllRanges(),h.addRange(d),document.execCommand("delete",!1),document.execCommand("insertText",!1,u);const M=new InputEvent("input",{bubbles:!0,cancelable:!1,inputType:"insertText",data:u});return t.dispatchEvent(M),this.log("TextBlitz: ✅ execCommand replacement successful"),!0}catch(r){return this.log("TextBlitz: Error in execCommand replacement",r),!1}}static async executeKeyboardAction(t,e){if(e.type==="delay"){const s=m.parseDelayMs(e.options);await new Promise(n=>setTimeout(n,s))}else e.type==="enter"?this.dispatchKey(t,"Enter"):e.type==="tab"&&this.dispatchKey(t,"Tab")}static async replace(t,e,s,n){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?await this.replaceInInput(t,e,s,n):t.isContentEditable?await this.replaceInContentEditable(t,e,s,n):!1}static isValidInputElement(t){if(this.log("TextBlitz: isValidInputElement check on",t.tagName,t instanceof HTMLInputElement?`type=${t.type}`:""),t instanceof HTMLInputElement&&t.type==="password")return this.log("TextBlitz: Skipping password field"),!1;if(t instanceof HTMLInputElement&&t.type==="hidden")return this.log("TextBlitz: Skipping hidden field"),!1;const e=t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t.isContentEditable;return this.log("TextBlitz: isValidInputElement returning:",e),e}};O.debugMode=!1;let x=O;const D=new Set([" ","	",`
`,"\r",".",",",";",":","!","?","-","_","(",")","[","]","{","}",'"',"'","/","\\","|","<",">"]);function L(p){return!p||p.length===0?!0:D.has(p)}function B(p,t,e,s){const n=p.length>0?p[p.length-1]:void 0,i=e.length>0?e[0]:void 0;switch(s){case"anywhere":return!0;case"word":return L(n);case"word-both":return L(n)&&L(i);default:return console.warn("Unknown trigger mode:",s),!1}}class E{constructor(t){this.config=t}}class $ extends E{constructor(){super(...arguments),this.baseURL="https://api.groq.com/openai/v1",this.model="llama-3.1-8b-instant"}async complete(t){const e=this.config.timeout||5e3,s=new AbortController,n=setTimeout(()=>s.abort(),e);try{const i=this.config.systemPrompt||"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",o=await fetch(`${this.baseURL}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.config.model||this.model,messages:[{role:"system",content:i},{role:"user",content:t.prompt}],max_tokens:t.maxTokens||100,temperature:t.temperature||.7}),signal:s.signal});if(clearTimeout(n),!o.ok){const c=await o.text();throw new Error(`Groq API error: ${o.status} - ${c}`)}const r=await o.json();if(!r.choices||r.choices.length===0)throw new Error("No response from Groq");const a=r.choices[0].message.content.trim(),l=r.usage||{prompt_tokens:0,completion_tokens:0,total_tokens:0};return{text:a,tokensUsed:{input:l.prompt_tokens,output:l.completion_tokens,total:l.total_tokens},model:r.model||this.model,provider:"groq"}}catch(i){throw clearTimeout(n),i.name==="AbortError"?new Error("Groq request timed out"):i}}async testConnection(){try{return await this.complete({prompt:'Say "test" and nothing else',maxTokens:10}),!0}catch{return!1}}getModelName(){return this.config.model||this.model}}class F extends E{constructor(){super(...arguments),this.baseURL="https://api.anthropic.com/v1",this.model="claude-sonnet-4-20250514",this.apiVersion="2023-06-01"}async complete(t){const e=this.config.timeout||5e3,s=new AbortController,n=setTimeout(()=>s.abort(),e);try{const i=this.config.systemPrompt||"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",o=await fetch(`${this.baseURL}/messages`,{method:"POST",headers:{"x-api-key":this.config.apiKey,"anthropic-version":this.apiVersion,"content-type":"application/json"},body:JSON.stringify({model:this.config.model||this.model,max_tokens:t.maxTokens||100,messages:[{role:"user",content:`${i}

${t.prompt}`}],temperature:t.temperature||.7}),signal:s.signal});if(clearTimeout(n),!o.ok){const c=await o.text();throw new Error(`Anthropic API error: ${o.status} - ${c}`)}const r=await o.json();if(!r.content||r.content.length===0)throw new Error("No response from Anthropic");const a=r.content[0].text.trim(),l=r.usage||{input_tokens:0,output_tokens:0};return{text:a,tokensUsed:{input:l.input_tokens,output:l.output_tokens,total:l.input_tokens+l.output_tokens},model:r.model||this.model,provider:"anthropic"}}catch(i){throw clearTimeout(n),i.name==="AbortError"?new Error("Anthropic request timed out"):i}}async testConnection(){try{return await this.complete({prompt:'Say "test" and nothing else',maxTokens:10}),!0}catch{return!1}}getModelName(){return this.config.model||this.model}}class N extends E{constructor(){super(...arguments),this.baseURL="https://api.openai.com/v1",this.model="gpt-4o-mini"}async complete(t){const e=this.config.timeout||5e3,s=new AbortController,n=setTimeout(()=>s.abort(),e);try{const i=this.config.systemPrompt||"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",o=await fetch(`${this.baseURL}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.config.model||this.model,messages:[{role:"system",content:i},{role:"user",content:t.prompt}],max_tokens:t.maxTokens||100,temperature:t.temperature||.7}),signal:s.signal});if(clearTimeout(n),!o.ok){const c=await o.text();throw new Error(`OpenAI API error: ${o.status} - ${c}`)}const r=await o.json();if(!r.choices||r.choices.length===0)throw new Error("No response from OpenAI");const a=r.choices[0].message.content.trim(),l=r.usage||{prompt_tokens:0,completion_tokens:0,total_tokens:0};return{text:a,tokensUsed:{input:l.prompt_tokens,output:l.completion_tokens,total:l.total_tokens},model:r.model||this.model,provider:"openai"}}catch(i){throw clearTimeout(n),i.name==="AbortError"?new Error("OpenAI request timed out"):i}}async testConnection(){try{return await this.complete({prompt:'Say "test" and nothing else',maxTokens:10}),!0}catch{return!1}}getModelName(){return this.config.model||this.model}}class U extends E{constructor(){super(...arguments),this.baseURL="https://generativelanguage.googleapis.com/v1beta",this.model="gemini-1.5-flash"}async complete(t){const e=this.config.timeout||5e3,s=new AbortController,n=setTimeout(()=>s.abort(),e);try{const i=this.config.systemPrompt||"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",o=this.config.model||this.model,r=await fetch(`${this.baseURL}/models/${o}:generateContent?key=${this.config.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`${i}

${t.prompt}`}]}],generationConfig:{maxOutputTokens:t.maxTokens||100,temperature:t.temperature||.7}}),signal:s.signal});if(clearTimeout(n),!r.ok){const w=await r.text();throw new Error(`Gemini API error: ${r.status} - ${w}`)}const a=await r.json();if(!a.candidates||a.candidates.length===0)throw new Error("No response from Gemini");const l=a.candidates[0];if(!l.content||!l.content.parts||l.content.parts.length===0)throw new Error("Invalid response structure from Gemini");const c=l.content.parts[0].text.trim(),u=a.usageMetadata||{},h=u.promptTokenCount||0,d=u.candidatesTokenCount||0;return{text:c,tokensUsed:{input:h,output:d,total:h+d},model:o,provider:"gemini"}}catch(i){throw clearTimeout(n),i.name==="AbortError"?new Error("Gemini request timed out"):i}}async testConnection(){try{return await this.complete({prompt:'Say "test" and nothing else',maxTokens:10}),!0}catch{return!1}}getModelName(){return this.config.model||this.model}}const R={groq:{free:{requestsPerMinute:30,requestsPerDay:14400},paid:{requestsPerMinute:300,requestsPerDay:144e3}},openai:{tier1:{requestsPerMinute:500,tokensPerMinute:3e4},tier2:{requestsPerMinute:5e3,tokensPerMinute:45e4},tier3:{requestsPerMinute:5e3,tokensPerMinute:2e6},tier4:{requestsPerMinute:1e4,tokensPerMinute:4e6},tier5:{requestsPerMinute:1e4,tokensPerMinute:2e7}},anthropic:{tier1:{requestsPerMinute:50,tokensPerMinute:4e4},tier2:{requestsPerMinute:1e3,tokensPerMinute:8e4},tier3:{requestsPerMinute:2e3,tokensPerMinute:16e4},tier4:{requestsPerMinute:4e3,tokensPerMinute:4e5}},gemini:{free:{requestsPerMinute:15},paid:{requestsPerMinute:1500}}},K={"llama-3.3-70b-versatile":{input:.59,output:.79},"llama-3.1-8b-instant":{input:.05,output:.08},"gpt-4o-mini":{input:.15,output:.6},"gpt-4o":{input:2.5,output:10},"claude-sonnet-4-20250514":{input:3,output:15},"claude-opus-4-20250514":{input:15,output:75},"gemini-2.0-flash-exp":{input:0,output:0},"gemini-2.5-pro":{input:1.25,output:5}};function I(p,t){const e=R[p];return e[t]||e[Object.keys(e)[0]]}function _(p){return K[p]||{input:0,output:0}}class Y{constructor(){this.stats=new Map,this.loadStats()}async loadStats(){try{const t=await chrome.storage.local.get("llmUsage");if(t.llmUsage)for(const e of["groq","anthropic","openai","gemini"]){const s=t.llmUsage[e];s&&this.stats.set(e,s)}}catch(t){console.error("Failed to load LLM usage stats:",t)}}async saveStats(){try{const t={};for(const e of["groq","anthropic","openai","gemini"])this.stats.has(e)&&(t[e]=this.stats.get(e));await chrome.storage.local.set({llmUsage:t})}catch(t){console.error("Failed to save LLM usage stats:",t)}}async getOrCreateStats(t){if(!this.stats.has(t)){const s=(await g.getSettings()).llmModels[t]||"";this.stats.set(t,{provider:t,model:s,requests:0,tokensInput:0,tokensOutput:0,tokensTotal:0,estimatedCost:0,lastReset:Date.now(),requestsThisMinute:0,minuteWindowStart:Date.now()})}return this.stats.get(t)}async canMakeRequest(t){const e=await this.getOrCreateStats(t),s=await g.getSettings(),n=Date.now();n-e.minuteWindowStart>6e4&&(e.requestsThisMinute=0,e.minuteWindowStart=n);let i;if(s.llmCustomLimits?.[t]?.requestsPerMinute)i=s.llmCustomLimits[t].requestsPerMinute;else{const o=s.llmTiers[t]||this.getDefaultTier(t);i=I(t,o).requestsPerMinute}return e.requestsThisMinute<i}async trackRequest(t){const e=await this.getOrCreateStats(t.provider),s=Date.now();s-e.minuteWindowStart>6e4&&(e.requestsThisMinute=0,e.minuteWindowStart=s),e.requests++,e.requestsThisMinute++,e.tokensInput+=t.tokensUsed.input,e.tokensOutput+=t.tokensUsed.output,e.tokensTotal+=t.tokensUsed.total,e.model=t.model;const n=_(t.model),i=t.tokensUsed.input/1e6*n.input,o=t.tokensUsed.output/1e6*n.output;e.estimatedCost+=i+o,await this.saveStats()}async getStats(t){return await this.getOrCreateStats(t)}async getAllStats(){return{groq:await this.getOrCreateStats("groq"),anthropic:await this.getOrCreateStats("anthropic"),openai:await this.getOrCreateStats("openai"),gemini:await this.getOrCreateStats("gemini")}}async resetStats(t){const e=await this.getOrCreateStats(t),n=(await g.getSettings()).llmModels[t]||"";e.model=n,e.requests=0,e.tokensInput=0,e.tokensOutput=0,e.tokensTotal=0,e.estimatedCost=0,e.lastReset=Date.now(),e.requestsThisMinute=0,e.minuteWindowStart=Date.now(),await this.saveStats()}async resetAllStats(){for(const t of["groq","anthropic","openai","gemini"])await this.resetStats(t)}async isApproachingLimit(t,e=80){const s=await this.getOrCreateStats(t),n=await g.getSettings();let i;if(n.llmCustomLimits?.[t]?.requestsPerMinute)i=n.llmCustomLimits[t].requestsPerMinute;else{const o=n.llmTiers[t]||this.getDefaultTier(t);i=I(t,o).requestsPerMinute}return s.requestsThisMinute>=i*(e/100)}async getRateLimit(t){const e=await g.getSettings();if(e.llmCustomLimits?.[t])return e.llmCustomLimits[t];const s=e.llmTiers[t]||this.getDefaultTier(t);return I(t,s)}getDefaultTier(t){return{groq:"free",openai:"tier1",anthropic:"tier1",gemini:"free"}[t]}}class W{constructor(){this.providers=new Map,this.usageTracker=new Y}setProvider(t,e,s,n,i){let o;const r={apiKey:e,model:s,timeout:n,systemPrompt:i};switch(t){case"groq":o=new $(r);break;case"anthropic":o=new F(r);break;case"openai":o=new N(r);break;case"gemini":o=new U(r);break;default:throw new Error(`Unknown provider: ${t}`)}this.providers.set(t,o)}async complete(t,e){const s=this.providers.get(t);if(!s)throw new Error(`Provider ${t} not initialized. Please add an API key in settings.`);if(!await this.usageTracker.canMakeRequest(t))throw new Error(`Rate limit exceeded for ${t}. Please wait a minute.`);await this.usageTracker.isApproachingLimit(t)&&console.warn(`TextBlitz: Approaching rate limit for ${t}`);const n=await s.complete(e);return await this.usageTracker.trackRequest(n),n}async testConnection(t){const e=this.providers.get(t);return e?e.testConnection():!1}getUsageTracker(){return this.usageTracker}}const b=new W;class G{constructor(){this.overlay=null,this.modal=null,this.onSubmit=null,this.onCancel=null}show(t,e,s){this.onSubmit=e,this.onCancel=s,this.overlay=document.createElement("div"),this.overlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
      z-index: 999999;
      display: flex;
      align-items: center;
      justify-content: center;
    `,this.modal=document.createElement("div"),this.modal.style.cssText=`
      background: white;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `,this.modal.innerHTML=`
      <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
        <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">
          Complete Snippet
        </h2>
        <p style="margin: 8px 0 0; font-size: 13px; color: #6b7280;">
          Fill in the fields below to insert your snippet
        </p>
      </div>
      <form id="textblitz-form" style="padding: 20px;">
        ${t.map(a=>this.renderField(a)).join("")}
      </form>
      <div style="padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; justify-content: flex-end;">
        <button
          type="button"
          id="textblitz-form-cancel"
          style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-size: 14px; font-weight: 500; cursor: pointer;"
        >
          Cancel
        </button>
        <button
          type="submit"
          form="textblitz-form"
          style="padding: 8px 16px; border: none; border-radius: 6px; background: #6366f1; color: white; font-size: 14px; font-weight: 500; cursor: pointer;"
        >
          Insert
        </button>
      </div>
    `,this.overlay.appendChild(this.modal),document.body.appendChild(this.overlay),this.modal.querySelector("#textblitz-form")?.addEventListener("submit",a=>{a.preventDefault(),this.handleSubmit(t)}),this.modal.querySelector("#textblitz-form-cancel")?.addEventListener("click",()=>this.handleCancel());const o=a=>{a.key==="Escape"&&(this.handleCancel(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o),this.modal.querySelector("input, textarea, select")?.focus()}renderField(t){const{type:e,name:s,label:n,options:i,defaultValue:o,required:r}=t;let a="";const l=r?"required":"",c=r?'<span style="color: #ef4444;">*</span>':"";switch(e){case"text":a=`
          <input
            type="text"
            name="${s}"
            id="${s}"
            value="${o||""}"
            ${l}
            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
          />
        `;break;case"paragraph":a=`
          <textarea
            name="${s}"
            id="${s}"
            rows="4"
            ${l}
            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; resize: vertical;"
          >${o||""}</textarea>
        `;break;case"menu":a=`
          <select
            name="${s}"
            id="${s}"
            ${l}
            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
          >
            ${i?.map(h=>`<option value="${h}">${h}</option>`).join("")||""}
          </select>
        `;break;case"date":a=`
          <input
            type="date"
            name="${s}"
            id="${s}"
            value="${o||""}"
            ${l}
            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
          />
        `;break;case"toggle":a=`
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input
              type="checkbox"
              name="${s}"
              id="${s}"
              ${o===!0||o==="true"?"checked":""}
              style="width: 18px; height: 18px; cursor: pointer;"
            />
            <span style="font-size: 14px; color: #374151;">Enabled</span>
          </label>
        `;break}return`
      <div style="margin-bottom: 16px;">
        <label
          for="${s}"
          style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #111827;"
        >
          ${n} ${c}
        </label>
        ${a}
      </div>
    `}handleSubmit(t){const e=this.modal?.querySelector("#textblitz-form");if(!e)return;const s={};for(const n of t){const i=e.elements.namedItem(n.name);i&&(n.type==="toggle"?s[n.name]=i.checked:s[n.name]=i.value)}this.onSubmit?.(s),this.hide()}handleCancel(){this.onCancel?.(),this.hide()}hide(){this.overlay&&(this.overlay.remove(),this.overlay=null),this.modal=null,this.onSubmit=null,this.onCancel=null}}class j{constructor(){this.settings=null,this.isExpanding=!1,this.trie=new A(!1),this.formPopup=new G,this.initialize()}async initialize(){console.log("TextBlitz: Starting initialization...");try{if(await g.initialize(),this.settings=await g.getSettings(),x.setDebugMode(this.settings.debugMode),this.settings.llmKeys.groq&&b.setProvider("groq",this.settings.llmKeys.groq,this.settings.llmModels.groq,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.llmKeys.anthropic&&b.setProvider("anthropic",this.settings.llmKeys.anthropic,this.settings.llmModels.anthropic,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.llmKeys.openai&&b.setProvider("openai",this.settings.llmKeys.openai,this.settings.llmModels.openai,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.llmKeys.gemini&&b.setProvider("gemini",this.settings.llmKeys.gemini,this.settings.llmModels.gemini,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.debugMode&&console.log("TextBlitz: Settings loaded",this.settings),!this.settings.enabled){console.log("TextBlitz: ❌ DISABLED in settings");return}const t=await g.getSnippets();this.trie.rebuild(t),this.setupListeners();const e=Object.keys(t).length;e===0?console.warn("TextBlitz: ⚠️ INITIALIZED but NO SNIPPETS FOUND!"):console.log("TextBlitz: ✅ Initialized with",e,"snippets")}catch(t){console.error("TextBlitz: ❌ Failed to initialize",t)}}setupListeners(){document.addEventListener("input",this.handleInput.bind(this),{passive:!0}),chrome.storage.onChanged.addListener((t,e)=>{e==="local"&&(t.snippets&&this.trie.rebuild(t.snippets.newValue||{}),t.settings&&(this.settings=t.settings.newValue,x.setDebugMode(this.settings.debugMode),this.settings.llmKeys.groq&&b.setProvider("groq",this.settings.llmKeys.groq,this.settings.llmModels.groq,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.llmKeys.anthropic&&b.setProvider("anthropic",this.settings.llmKeys.anthropic,this.settings.llmModels.anthropic,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.llmKeys.openai&&b.setProvider("openai",this.settings.llmKeys.openai,this.settings.llmModels.openai,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.llmKeys.gemini&&b.setProvider("gemini",this.settings.llmKeys.gemini,this.settings.llmModels.gemini,this.settings.llmTimeout,this.settings.llmSystemPrompt)))})}handleInput(t){const e=t.target;this.settings?.enabled&&(this.isExpanding||x.isValidInputElement(e)&&this.checkForMatch(e))}async checkForMatch(t){let e,s;if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement){const l=t.selectionStart??t.value.length;if(l===0)return!1;e=t.value.substring(0,l),s=t.value.substring(l)}else if(t.isContentEditable){const l=window.getSelection();if(!l||l.rangeCount===0)return!1;const c=l.getRangeAt(0),{startContainer:u,startOffset:h}=c;if(u.nodeType!==Node.TEXT_NODE)return!1;const w=u.textContent||"";e=w.substring(0,h),s=w.substring(h)}else return!1;if(!e)return!1;const n=this.trie.findMatch(e);if(!n)return!1;const{snippet:i}=n,o=this.settings.caseSensitive?i.trigger:i.trigger.toLowerCase();if(!(this.settings.caseSensitive?e:e.toLowerCase()).endsWith(o))return!1;const a=e.substring(0,e.length-o.length);if(!B(a,o,s,i.triggerMode))return!1;if(m.hasFormCommands(i.expansion))return await this.expandWithForm(t,i),!0;if(i.type==="dynamic")return await this.expandDynamic(t,i),!0;{this.isExpanding=!0;const l=await x.replace(t,i.trigger,i.expansion,i.caseTransform);return this.isExpanding=!1,l&&g.incrementUsage(i.id).catch(c=>{console.error("TextBlitz: Failed to update usage stats",c)}),l}}async expandWithForm(t,e){this.isExpanding=!0;try{const s=m.extractFormFields(e.expansion);if(s.length===0){console.warn("TextBlitz: No form fields found in expansion");return}await new Promise((n,i)=>{this.formPopup.show(s,async o=>{try{let r=m.substituteFormValues(e.expansion,o);r=await m.processCommands(r),await x.replace(t,e.trigger,r,e.caseTransform)&&g.incrementUsage(e.id).catch(l=>{console.error("TextBlitz: Failed to update usage stats",l)}),n()}catch(r){console.error("TextBlitz: Form expansion failed:",r),i(r)}},()=>{console.log("TextBlitz: Form cancelled by user"),n()})})}catch(s){console.error("TextBlitz: Form popup error:",s)}finally{this.isExpanding=!1}}async expandDynamic(t,e){this.isExpanding=!0;try{const s=e.llmProvider||this.settings.llmDefaultProvider,n=e.llmPrompt;if(!n)throw new Error("No LLM prompt defined for dynamic snippet");const i=await b.complete(s,{prompt:n,maxTokens:this.settings.llmMaxTokens,temperature:.7});await x.replace(t,e.trigger,i.text,e.caseTransform)&&g.incrementUsage(e.id).catch(r=>{console.error("TextBlitz: Failed to update usage stats",r)})}catch(s){console.error("TextBlitz: LLM expansion failed:",s);let n="LLM failed";s instanceof Error&&(s.message.includes("not initialized")||s.message.includes("API key")?n="LLM not configured - add API key in settings":s.message.includes("rate limit")?n="Rate limited - wait a moment":n=`LLM error: ${s.message}`),e.fallbackText?await x.replace(t,e.trigger,e.fallbackText,e.caseTransform):await x.replace(t,e.trigger,`[${n}]`,e.caseTransform)}finally{this.isExpanding=!1}}}console.log("TextBlitz: Content script loaded!");try{new j}catch(p){console.error("TextBlitz: Failed to create expander",p)}})();
