(function(){"use strict";const A={enabled:!0,delimiter:" ",expandOnDelimiter:!0,caseSensitive:!1,debugMode:!1,darkMode:"system",customFolders:[],llmKeys:{},llmDefaultProvider:"groq",llmTimeout:5e3,llmMaxTokens:100,llmSystemPrompt:"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",llmUsageAlert:80,llmModels:{groq:"llama-3.3-70b-versatile",openai:"gpt-4o-mini",anthropic:"claude-sonnet-4-20250514",gemini:"gemini-2.0-flash-exp"},llmTiers:{groq:"free",openai:"tier1",anthropic:"tier1",gemini:"free"}},L=class L{static async initialize(){if(this.initialized){console.log("StorageManager: Already initialized, skipping");return}return this.initPromise?this.initPromise:(this.initPromise=this._doInitialize(),this.initPromise)}static async _doInitialize(){if(!this.initialized){if(this.initialized=!0,console.log("StorageManager: Starting initialization..."),typeof chrome>"u")throw new Error("chrome API is not available");if(!chrome.storage)throw new Error("chrome.storage API is not available");if(!chrome.storage.local)throw new Error("chrome.storage.local API is not available");console.log("StorageManager: ✅ chrome.storage.local is available");try{const e=await Promise.race([chrome.storage.local.get(["snippets","settings"]),new Promise((n,o)=>setTimeout(()=>o(new Error("Storage get timed out after 5000ms")),5e3))]),s=e.snippets||{};let i=!1;for(const n of Object.values(s))n.triggerMode||(n.triggerMode="word",i=!0),n.label||(n.label=n.trigger,i=!0);this.snippetCache=s,this.settingsCache={...A,...e.settings},i&&(console.log("StorageManager: Updating snippets with triggerMode"),await chrome.storage.local.set({snippets:this.snippetCache})),console.log("StorageManager: Loaded",Object.keys(this.snippetCache).length,"snippets"),(!e.settings||JSON.stringify(Object.keys(e.settings))!==JSON.stringify(Object.keys(A)))&&(console.log("StorageManager: Updating settings with new fields"),await chrome.storage.local.set({settings:this.settingsCache})),chrome.storage.onChanged.addListener((n,o)=>{o==="local"&&(n.snippets&&(this.snippetCache=n.snippets.newValue||{}),n.settings&&(this.settingsCache=n.settings.newValue||A))}),console.log("StorageManager: ✅ Initialized successfully")}catch(t){throw this.initialized=!1,this.initPromise=null,console.error("StorageManager: ❌ Failed to initialize:",t),t}}}static async getSnippets(){return this.initialized||await this.initialize(),this.snippetCache}static async getSnippet(t){return this.initialized||await this.initialize(),this.snippetCache[t]}static async saveSnippet(t){this.initialized||await this.initialize(),this.snippetCache[t.id]=t,await chrome.storage.local.set({snippets:this.snippetCache})}static async deleteSnippet(t){this.initialized||await this.initialize(),delete this.snippetCache[t],await chrome.storage.local.set({snippets:this.snippetCache})}static async getSettings(){return this.initialized||await this.initialize(),this.settingsCache}static async saveSettings(t){this.initialized||await this.initialize(),this.settingsCache=t,await chrome.storage.local.set({settings:t})}static async incrementUsage(t){this.initialized||await this.initialize();const e=this.snippetCache[t];e&&(e.usageCount++,e.lastUsed=Date.now(),await this.saveSnippet(e))}static async exportData(){return this.initialized||await this.initialize(),{snippets:this.snippetCache,settings:this.settingsCache}}static async importData(t){this.initialized||await this.initialize(),t.snippets&&(this.snippetCache={...this.snippetCache,...t.snippets},await chrome.storage.local.set({snippets:this.snippetCache})),t.settings&&(this.settingsCache={...this.settingsCache,...t.settings},await chrome.storage.local.set({settings:this.settingsCache}))}};L.snippetCache={},L.settingsCache=A,L.initialized=!1,L.initPromise=null;let y=L;class D{constructor(){this.children=new Map,this.snippet=null,this.isEndOfWord=!1}}class N{constructor(){this.root=new D}insert(t){if(!t.enabled)return;const e=t.trigger.toLowerCase();let s=this.root;for(const i of e){const n=i.toLowerCase();s.children.has(n)||s.children.set(n,new D),s=s.children.get(n)}s.isEndOfWord=!0,s.snippet=t}search(t){const e=t.toLowerCase();let s=this.root;for(const i of e){const n=i.toLowerCase();if(!s.children.has(n))return null;s=s.children.get(n)}return s.isEndOfWord?s.snippet:null}findMatch(t){if(t.length===0)return null;let e=null;for(let s=t.length;s>0;s--){const i=t.substring(t.length-s),n=this.search(i);n&&(!e||s>e.matchLength)&&(e={snippet:n,matchLength:s})}return e}rebuild(t){this.root=new D,Object.values(t).forEach(e=>this.insert(e))}clear(){this.root=new D}}const k=class k{static parse(t){const e=[],s=new RegExp(this.COMMAND_REGEX);let i;for(;(i=s.exec(t))!==null;){const[n,o,r]=i;e.push({type:o,options:r?.trim()||void 0,startIndex:i.index,endIndex:i.index+n.length,rawMatch:n})}return e}static parseFormCommands(t){const e=[],s=new RegExp(this.FORM_COMMAND_REGEX);let i;for(;(i=s.exec(t))!==null;){const[n,o,r]=i,a=this.parseFormField(o,r);a&&e.push({type:"form",options:r,startIndex:i.index,endIndex:i.index+n.length,rawMatch:n,formField:a})}return e}static parseFormField(t,e){const s=e.split(";").map(a=>a.trim()),i={};for(const a of s){const[l,c]=a.split("=").map(h=>h.trim());l&&c&&(i[l]=c)}const n=i.label||i.name||"Field",o=i.name||n.toLowerCase().replace(/\s+/g,"_"),r={type:t.replace("form",""),name:o,label:n,required:i.required==="true"};return t==="formmenu"&&i.options&&(r.options=i.options.split(",").map(a=>a.trim())),i.default&&(r.defaultValue=t==="formtoggle"?i.default==="true":i.default),r}static hasFormCommands(t){return this.FORM_COMMAND_REGEX.test(t)}static extractFormFields(t){return this.parseFormCommands(t).map(s=>s.formField).filter(Boolean)}static stripNotes(t){return t.replace(this.NOTE_BLOCK_REGEX,"").replace(this.NOTE_INLINE_REGEX,"")}static getSiteInfo(t){switch(t.toLowerCase().trim()){case"domain":return window.location.hostname;case"title":return document.title;case"url":return window.location.href;case"selection":return window.getSelection()?.toString()||"";default:return console.warn(`TextBlitz: Unknown site parameter: ${t}`),""}}static addToHistory(t){!t||this.clipboardHistory.length>0&&this.clipboardHistory[0]===t||(this.clipboardHistory.unshift(t),this.clipboardHistory.length>this.MAX_HISTORY&&(this.clipboardHistory=this.clipboardHistory.slice(0,this.MAX_HISTORY)))}static getClipboardHistory(t){return this.clipboardHistory[t-1]||""}static clearClipboardHistory(){this.clipboardHistory=[]}static normalizeKeyName(t){const e=t.toLowerCase().trim();return this.KEY_MAP[e]||null}static getOrdinalSuffix(t){if(t>=11&&t<=13)return"th";switch(t%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}static parseDateShift(t){const e=t.match(/shift\s+([+-]?\d+)([dMY])/);if(!e)return null;const s=parseInt(e[1],10),i=e[2];return{value:s,unit:i}}static applyDateShift(t,e){const s=new Date(t);switch(e.unit){case"d":s.setDate(s.getDate()+e.value);break;case"M":s.setMonth(s.getMonth()+e.value);break;case"Y":s.setFullYear(s.getFullYear()+e.value);break}return s}static formatDate(t,e){let s=t,i=e||"YYYY-MM-DD";if(e){const g=this.parseDateShift(e);g&&(s=this.applyDateShift(t,g),i=e.replace(/\s*shift\s+[+-]?\d+[dMY]\s*/,"").trim()||"YYYY-MM-DD")}const n=s.getFullYear(),o=String(s.getMonth()+1).padStart(2,"0"),r=s.getDate(),a=String(r).padStart(2,"0"),l=s.toLocaleDateString("en-US",{month:"long"}),c=s.toLocaleDateString("en-US",{month:"short"}),h={YYYY:String(n),YY:String(n).slice(-2),MMMM:l,MMM:c,MM:o,M:String(s.getMonth()+1),Do:`${r}${this.getOrdinalSuffix(r)}`,DD:a,D:String(r)},d=Object.keys(h).sort((g,f)=>f.length-g.length),p=new RegExp(d.join("|"),"g");return i.replace(p,g=>h[g]||g)}static formatTime(t,e){const i=e||"HH:mm",n=t.getHours(),o=n%12||12,r=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0"),l=n>=12?"PM":"AM";return i==="12h"?`${o}:${r} ${l}`:i==="24h"?`${String(n).padStart(2,"0")}:${r}`:i.replace("HH",String(n).padStart(2,"0")).replace("H",String(n)).replace("hh",String(o).padStart(2,"0")).replace("h",String(o)).replace("mm",r).replace("ss",a).replace("A",l).replace("a",l.toLowerCase())}static parseDelayMs(t){if(!t)return 0;const e=t.match(/\+?(\d+(?:\.\d+)?)(s|ms)?/);if(!e)return 0;const s=parseFloat(e[1]);return(e[2]||"s")==="ms"?s:s*1e3}static async processCommands(t){const e=this.parse(t);if(e.length===0)return t;let s=t;const i=new Date;for(let n=e.length-1;n>=0;n--){const o=e[n];let r;switch(o.type){case"date":r=this.formatDate(i,o.options);break;case"time":r=this.formatTime(i,o.options);break;case"clipboard":const a=o.rawMatch.match(/clipboardh(\d+)/);if(a){const l=parseInt(a[1],10)-1;r=this.clipboardHistory[l]||""}else try{r=await navigator.clipboard.readText(),this.addToHistory(r)}catch{console.warn("TextBlitz: Clipboard access denied or unavailable"),r=o.rawMatch}break;case"site":r=this.getSiteInfo(o.options||"url");break;case"cursor":case"enter":case"tab":case"delay":case"key":continue;default:r=o.rawMatch}s=s.slice(0,o.startIndex)+r+s.slice(o.endIndex)}return s}static extractKeyboardActions(t){const e=this.parse(t),s=[];let i=t,n=0;for(const o of e)if(o.type==="enter"||o.type==="tab"||o.type==="delay"||o.type==="key"){const r=o.startIndex-n;s.push({type:o.type,options:o.options,position:r}),i=i.slice(0,o.startIndex-n)+i.slice(o.endIndex-n),n+=o.rawMatch.length}return{text:i,actions:s}}static splitTextByKeyboardActions(t){const s=this.parse(t).filter(r=>r.type==="enter"||r.type==="tab"||r.type==="delay"||r.type==="key");if(s.length===0)return{chunks:[t],actions:[]};const i=[],n=[];let o=0;for(const r of s)i.push(t.substring(o,r.startIndex)),n.push({type:r.type,options:r.options}),o=r.endIndex;return i.push(t.substring(o)),{chunks:i,actions:n}}static substituteFormValues(t,e){const s=this.parseFormCommands(t);if(s.length===0)return t;let i=t;for(let n=s.length-1;n>=0;n--){const o=s[n];if(o.formField){const r=e[o.formField.name],a=r!==void 0?String(r):"";i=i.slice(0,o.startIndex)+a+i.slice(o.endIndex)}}return i}};k.clipboardHistory=[],k.MAX_HISTORY=10,k.COMMAND_REGEX=/\{(date|time|clipboard(?:h\d+)?|cursor|enter|tab|delay|site|key)(?:[\s:]([^}]+))?\}/g,k.FORM_COMMAND_REGEX=/\{(formtext|formparagraph|formmenu|formdate|formtoggle):([^}]+)\}/g,k.NOTE_BLOCK_REGEX=/\{note\}(.*?)\{endnote\}/gs,k.NOTE_INLINE_REGEX=/\{note:\s*[^}]*\}/g,k.KEY_MAP={enter:{code:"Enter",key:"Enter",keyCode:13},tab:{code:"Tab",key:"Tab",keyCode:9},escape:{code:"Escape",key:"Escape",keyCode:27},esc:{code:"Escape",key:"Escape",keyCode:27},backspace:{code:"Backspace",key:"Backspace",keyCode:8},delete:{code:"Delete",key:"Delete",keyCode:46},arrowup:{code:"ArrowUp",key:"ArrowUp",keyCode:38},arrowdown:{code:"ArrowDown",key:"ArrowDown",keyCode:40},arrowleft:{code:"ArrowLeft",key:"ArrowLeft",keyCode:37},arrowright:{code:"ArrowRight",key:"ArrowRight",keyCode:39},home:{code:"Home",key:"Home",keyCode:36},end:{code:"End",key:"End",keyCode:35},pageup:{code:"PageUp",key:"PageUp",keyCode:33},pagedown:{code:"PageDown",key:"PageDown",keyCode:34},space:{code:"Space",key:" ",keyCode:32},f1:{code:"F1",key:"F1",keyCode:112},f2:{code:"F2",key:"F2",keyCode:113},f3:{code:"F3",key:"F3",keyCode:114},f4:{code:"F4",key:"F4",keyCode:115},f5:{code:"F5",key:"F5",keyCode:116},f6:{code:"F6",key:"F6",keyCode:117},f7:{code:"F7",key:"F7",keyCode:118},f8:{code:"F8",key:"F8",keyCode:119},f9:{code:"F9",key:"F9",keyCode:120},f10:{code:"F10",key:"F10",keyCode:121},f11:{code:"F11",key:"F11",keyCode:122},f12:{code:"F12",key:"F12",keyCode:123}};let b=k;const H=Object.freeze(Object.defineProperty({__proto__:null,CommandParser:b},Symbol.toStringTag,{value:"Module"}));class q{static detectCase(t){if(!t)return"lower";const e=/[a-z]/.test(t),s=/[A-Z]/.test(t);if(!e&&!s)return"lower";if(!e&&s)return"upper";if(e&&!s)return"lower";if(/^[A-Z]/.test(t)){const i=t.split(/\s+/),n=i.filter(o=>/^[A-Z]/.test(o));return n.length>1||i.length>1&&n.length===i.length?"title":"capitalize"}return"mixed"}static transform(t,e,s){switch(e){case"upper":return t.toUpperCase();case"lower":return t.toLowerCase();case"title":return this.toTitleCase(t);case"capitalize":return this.capitalize(t);case"match":return s?this.matchCase(t,s):t;case"none":default:return t}}static toTitleCase(t){return t.split(/(\s+)/).map(e=>/^\s+$/.test(e)?e:e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join("")}static capitalize(t){return t&&t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}static matchCase(t,e){switch(this.detectCase(e)){case"upper":return t.toUpperCase();case"lower":return t.toLowerCase();case"title":return this.toTitleCase(t);case"capitalize":return this.capitalize(t);default:return t}}}class v{constructor(){this.logs=[],this.debugMode=!1,this.maxLogs=30,this.initialized=!1,this.sessionId=`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,this.loadFromStorage()}static getInstance(){return v.instance||(v.instance=new v),v.instance}setDebugMode(t){this.debugMode=t}async loadFromStorage(){if(!this.initialized)try{const t=await chrome.storage.local.get("logBuffer");t.logBuffer&&Array.isArray(t.logBuffer)&&(this.logs=t.logBuffer.slice(-this.maxLogs)),this.initialized=!0}catch(t){console.error("TextBlitz: Failed to load logs from storage",t),this.initialized=!0}}async saveToStorage(){try{await chrome.storage.local.set({logBuffer:this.logs.slice(-this.maxLogs)})}catch{}}addLog(t){t.context||(t.context={}),t.context.sessionId=this.sessionId;const e=this.sanitizeLogEntry(t);this.logs.push(e),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs)),this.saveToStorage()}sanitizeLogEntry(t){const e={...t};return e.context&&(e.context=this.sanitizeContext(e.context)),e}sanitizeContext(t){const e={...t};if(e.site?.url)try{const s=new URL(e.site.url);e.site.url=`${s.protocol}//${s.hostname}${s.pathname}`}catch{e.site.url="[INVALID_URL]"}return e.error&&(e.error=this.sanitizeString(e.error)),e}sanitizeString(t){return/@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(t)&&(t=t.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,"[EMAIL]")),/^(Bearer|sk-|gsk_|sk-ant-|AI)[a-zA-Z0-9_-]{20,}/.test(t)?"[TOKEN]":/^[a-zA-Z0-9_-]{32,}$/.test(t)?"[KEY]":t.length>500?t.substring(0,500)+"...[truncated]":t}info(t,e,s){const i={level:"info",category:t,message:e,context:s,timestamp:Date.now()};this.addLog(i),this.debugMode&&console.log(`TextBlitz [${t}]:`,e,s||"")}warn(t,e,s){const i={level:"warn",category:t,message:e,context:s,timestamp:Date.now()};this.addLog(i),this.debugMode&&console.warn(`TextBlitz [${t}]:`,e,s||"")}error(t,e,s){const i={level:"error",category:t,message:e,context:s,timestamp:Date.now()};this.addLog(i),console.error(`TextBlitz [${t}]:`,e,s||"")}debug(t,e,s){const i={level:"debug",category:t,message:e,context:s,timestamp:Date.now()};this.addLog(i),this.debugMode&&console.log(`TextBlitz [${t}] DEBUG:`,e,s||"")}getElementContext(t){return{tag:t.tagName,type:t instanceof HTMLInputElement?t.type:void 0,id:t.id||void 0,classes:t.className||void 0,contentEditable:t.isContentEditable}}getSiteContext(){return{hostname:window.location.hostname,url:window.location.href}}getRecentLogs(t=50){return this.logs.slice(-t)}getLogsByCategory(t){return this.logs.filter(e=>e.category===t)}getErrors(){return this.logs.filter(t=>t.level==="error")}getLogsPreview(){if(this.logs.length===0)return"No logs recorded yet.";let t="";return this.logs.forEach((e,s)=>{const i=new Date(e.timestamp).toLocaleTimeString();t+=`${s+1}. [${i}] ${e.level.toUpperCase()} - ${e.category}: ${e.message}
`}),t}formatForGitHub(t=!1,e){const s=this.getErrors(),i=this.getRecentLogs(30);let n=`## 🐛 Bug Report

`;n+=`**Session ID:** ${this.sessionId}
`,n+=`**Timestamp:** ${new Date().toISOString()}
`;try{n+=`**Extension Version:** ${chrome.runtime.getManifest().version}
`}catch{n+=`**Extension Version:** Unknown
`}return n+=`**Browser:** ${navigator.userAgent}

`,s.length>0&&(n+=`### ❌ Errors

`,s.forEach((o,r)=>{const a=new Date(o.timestamp).toLocaleTimeString();n+=`${r+1}. **[${a}] ${o.category}**: ${o.message}
`,o.context&&(n+=`   <details>
   <summary>Details</summary>

   \`\`\`json
   ${JSON.stringify(o.context,null,2)}
   \`\`\`
   </details>

`)})),n+=`<details>
<summary>📋 Last 30 Log Entries</summary>

\`\`\`
`,i.forEach(o=>{const r=new Date(o.timestamp).toLocaleTimeString();n+=`[${r}] ${o.level.padEnd(5)} | ${o.category.padEnd(10)} | ${o.message}
`}),n+="```\n</details>\n\n",t&&e&&(n+=`<details>
<summary>📝 Snippet Details</summary>

\`\`\`json
`,n+=JSON.stringify(e,null,2),n+=`
\`\`\`
</details>

`),n}clearLogs(){this.logs=[]}}const m=v.getInstance();class ${constructor(){this.debugMode=!1}setDebugMode(t){this.debugMode=t}log(...t){this.debugMode&&console.log(`[${this.name}]`,...t)}async delay(t){return new Promise(e=>setTimeout(e,t))}getElementText(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value:t.textContent||""}findTrigger(t,e){if(t.endsWith(e))return{start:t.length-e.length,end:t.length};const s=t.lastIndexOf(e);return s!==-1?{start:s,end:s+e.length}:null}verify(t,e,s){const i=this.getElementText(t),n=e.substring(0,Math.min(10,e.length));return i.includes(n)?i.endsWith(s)?(this.log("Verification failed: trigger still present"),!1):!0:(this.log("Verification failed: expansion not found"),!1)}async executeKeyboardAction(t,e){switch(e.type){case"enter":await this.executeEnter(t);break;case"tab":await this.executeTab(t);break;case"delay":await this.executeDelay(e.options);break;case"key":await this.executeKey(t,e.options);break}}async executeEnter(t){if(this.log("Executing {enter}"),t instanceof HTMLTextAreaElement||t.isContentEditable){const e=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,bubbles:!0,cancelable:!0});t.dispatchEvent(e)}else if(t instanceof HTMLInputElement){const e=t.form;e?e.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0})):t.blur()}}async executeTab(t){this.log("Executing {tab}");const e=Array.from(document.querySelectorAll('input:not([disabled]):not([type="hidden"]), textarea:not([disabled]), select:not([disabled]), button:not([disabled]), [contenteditable="true"], [tabindex]:not([tabindex="-1"])')),s=e.indexOf(t);s!==-1&&s<e.length-1&&e[s+1].focus()}async executeDelay(t){let s=1e3;if(t){const i=t.match(/\+?(\d+(?:\.\d+)?)(s|ms)?/);if(i){const n=parseFloat(i[1]);s=(i[2]||"s")==="ms"?n:n*1e3}}this.log(`Executing {delay} for ${s}ms`),await this.delay(s)}async executeKey(t,e){if(!e){console.warn("TextBlitz: {key} command requires a key name");return}const{CommandParser:s}=await Promise.resolve().then(()=>H),i=s.normalizeKeyName(e);if(!i){console.warn(`TextBlitz: Unknown key name: ${e}`);return}this.log(`Executing {key: ${e}} → ${i.code}`);const n=new KeyboardEvent("keydown",{key:i.key,code:i.code,keyCode:i.keyCode,bubbles:!0,cancelable:!0});t.dispatchEvent(n)}}class R{static isGoogleDocs(t){return!!(window.location.hostname.includes("docs.google.com")||t&&(t.classList.contains("kix-cursor")||t.closest(".kix-appview-editor")||document.querySelector(".kix-appview-editor")))}static isReact(t){return Object.keys(t).some(s=>s.startsWith("__react")||s.startsWith("_react")||s.startsWith("__REACT"))}static isVue(t){return"__vue__"in t||"__vueParentComponent"in t||"__v_skip"in t}static isShadowDOM(t){return!!t.shadowRoot||!!t.closest("[shadowroot]")}static isCustomEditor(t){return t.classList.contains("CodeMirror")||t.classList.contains("monaco-editor")||t.getAttribute("data-lexical-editor")!==null||t.classList.contains("ProseMirror")}static getSiteType(t){return this.isGoogleDocs(t)?"google-docs":this.isCustomEditor(t)?"custom-editor":this.isReact(t)?"react":this.isVue(t)?"vue":this.isShadowDOM(t)?"shadow-dom":"standard"}}class _ extends ${constructor(){super(...arguments),this.name="GoogleDocs",this.priority=10}canHandle(t){return R.isGoogleDocs(t)}async replace(t,e,s,i,n,o){if(this.log("Starting Google Docs replacement"),t.focus(),await this.delay(50),!this.getElementText(t).endsWith(e))return this.log("Trigger not found at end of text"),!1;for(let h=0;h<e.length;h++)document.execCommand("delete",!1);await this.delay(100);let a=0,l=this.getElementText(t);for(;l.endsWith(e)&&a<3;){this.log(`Deletion retry ${a+1}/3`);const h=window.getSelection();if(h&&h.rangeCount>0){const d=h.getRangeAt(0);let{startContainer:p,startOffset:g}=d;if(p.nodeType!==Node.TEXT_NODE&&p.childNodes.length>0){const f=Math.min(g,p.childNodes.length-1),w=p.childNodes[f];w&&w.nodeType===Node.TEXT_NODE&&(p=w,g=w.textContent?.length||0)}if(p.nodeType===Node.TEXT_NODE){const f=p;if((f.textContent||"").substring(0,g).endsWith(e)){const C=document.createRange();C.setStart(f,g-e.length),C.setEnd(f,g),h.removeAllRanges(),h.addRange(C),document.execCommand("delete",!1),await this.delay(100)}}}a++,l=this.getElementText(t)}return l.endsWith(e)?(this.log("Deletion failed after retries"),!1):(await this.delay(50),n&&n.length>0&&o&&o.length>0?await this.replaceWithChunks(t,n,o,e,s):document.execCommand("insertText",!1,s)?(i!==void 0&&i<s.length&&await this.setCursorPosition(t,i,s),await this.delay(200),this.verify(t,s,e)):(this.log("insertText failed"),!1))}async replaceWithChunks(t,e,s,i,n){this.log(`Replacing with ${e.length} chunks and ${s.length} actions`);for(let o=0;o<e.length;o++){if(!document.execCommand("insertText",!1,e[o]))return this.log(`Failed to insert chunk ${o}`),!1;await this.delay(100),o<s.length&&(await this.executeKeyboardAction(t,s[o]),await this.delay(100))}return await this.delay(200),this.verify(t,n,i)}async setCursorPosition(t,e,s){this.log(`Setting cursor position to offset ${e}`);const i=window.getSelection();if(!(!i||i.rangeCount===0))try{const n=i.getRangeAt(0),{startContainer:o}=n;if(o.nodeType===Node.TEXT_NODE){const r=o,a=r.textContent||"",l=a.length-(s.length-e);l>=0&&l<=a.length&&(n.setStart(r,l),n.setEnd(r,l),i.removeAllRanges(),i.addRange(n))}}catch(n){this.log("Failed to set cursor position:",n)}}}class B extends ${constructor(){super(...arguments),this.name="React",this.priority=5}canHandle(t){return R.isReact(t)&&(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)}async replace(t,e,s,i,n,o){if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement))return!1;this.log("Starting React-specific replacement");const r=t.value,a=t.selectionStart??r.length;let l=-1,c=-1;if(r.substring(0,a).endsWith(e)?(l=a-e.length,c=a):r.endsWith(e)?(l=r.length-e.length,c=r.length):(l=r.lastIndexOf(e),l!==-1&&(c=l+e.length)),l===-1)return this.log("Trigger not found"),!1;const d=r.substring(0,l),p=r.substring(c);if(n&&n.length>0&&o&&o.length>0)return await this.replaceWithChunks(t,d,p,n,o,e,s,i);const g=d+s+p,f=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set,w=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;t instanceof HTMLInputElement&&f?f.call(t,g):t instanceof HTMLTextAreaElement&&w?w.call(t,g):t.value=g;const T=t._valueTracker;T&&T.setValue(""),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}));const C=d.length+(i??s.length);try{t.setSelectionRange(C,C)}catch{}return await this.delay(10),this.verify(t,s,e)}async replaceWithChunks(t,e,s,i,n,o,r,a){this.log(`Replacing with ${i.length} chunks and ${n.length} actions`);const l=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set,c=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;let h=e;for(let d=0;d<i.length;d++){if(i[d].length===0&&d<i.length-1){d<n.length&&await this.executeKeyboardAction(t,n[d]);continue}h+=i[d];const p=h+s;t instanceof HTMLInputElement&&l?l.call(t,p):t instanceof HTMLTextAreaElement&&c?c.call(t,p):t.value=p;const g=t._valueTracker;g&&g.setValue(""),t.dispatchEvent(new Event("input",{bubbles:!0}));const f=h.length;try{t.setSelectionRange(f,f)}catch{}d<n.length&&await this.executeKeyboardAction(t,n[d])}if(a!==void 0){const d=e.length+a;try{t.setSelectionRange(d,d),this.log(`Set cursor to offset ${a} (absolute pos ${d})`)}catch(p){this.log("Failed to set cursor position:",p)}}return t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(10),this.verify(t,r,o)}}class U extends ${constructor(){super(...arguments),this.name="ContentEditable",this.priority=3}canHandle(t){return t.isContentEditable}async replace(t,e,s,i,n,o){this.log("Starting contenteditable replacement");const r=window.getSelection();if(!r||r.rangeCount===0)return this.log("No selection available"),!1;const a=r.getRangeAt(0);let{startContainer:l,startOffset:c}=a;if(l.nodeType!==Node.TEXT_NODE)if(l.childNodes.length>0){const C=Math.min(c,l.childNodes.length-1),M=l.childNodes[C];if(M&&M.nodeType===Node.TEXT_NODE)l=M,c=M.textContent?.length||0;else return this.log("Could not find text node"),!1}else return this.log("No child nodes"),!1;const h=l;if(!(h.textContent||"").substring(0,c).endsWith(e))return this.log("Trigger not found before cursor"),!1;const g=document.createRange(),f=c-e.length;return g.setStart(h,f),g.setEnd(h,c),r.removeAllRanges(),r.addRange(g),document.execCommand("delete",!1)?n&&n.length>0&&o&&o.length>0?await this.replaceWithChunks(t,n,o,e,s,i):document.execCommand("insertText",!1,s)?(i!==void 0&&i<s.length&&await this.setCursorPosition(t,i,s),t.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(10),this.verify(t,s,e)):(this.log("InsertText command failed"),!1):(this.log("Delete command failed"),!1)}async replaceWithChunks(t,e,s,i,n,o){this.log(`Replacing with ${e.length} chunks and ${s.length} actions`);let r=0;for(let a=0;a<e.length;a++){if(e[a].length===0&&a<e.length-1){a<s.length&&await this.executeKeyboardAction(t,s[a]);continue}if(!document.execCommand("insertText",!1,e[a]))return this.log(`Failed to insert chunk ${a}`),!1;r+=e[a].length,t.dispatchEvent(new Event("input",{bubbles:!0})),a<s.length&&await this.executeKeyboardAction(t,s[a])}return o!==void 0&&o<r&&await this.setCursorFromEnd(t,r-o),await this.delay(10),this.verify(t,n,i)}async setCursorFromEnd(t,e){const s=window.getSelection();if(!(!s||s.rangeCount===0))try{const i=s.getRangeAt(0),{startContainer:n,startOffset:o}=i;if(n.nodeType===Node.TEXT_NODE){const r=n,a=Math.max(0,o-e);i.setStart(r,a),i.setEnd(r,a),s.removeAllRanges(),s.addRange(i),this.log(`Moved cursor back ${e} chars to position ${a}`)}}catch(i){this.log("Failed to move cursor:",i)}}async setCursorPosition(t,e,s){this.log(`Setting cursor position to offset ${e}`);const i=window.getSelection();if(!(!i||i.rangeCount===0))try{const n=i.getRangeAt(0),{startContainer:o}=n;if(o.nodeType===Node.TEXT_NODE){const r=o,a=r.textContent||"",l=a.length-(s.length-e);l>=0&&l<=a.length&&(n.setStart(r,l),n.setEnd(r,l),i.removeAllRanges(),i.addRange(n))}}catch(n){this.log("Failed to set cursor position:",n)}}}class K extends ${constructor(){super(...arguments),this.name="Standard",this.priority=1}canHandle(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement}async replace(t,e,s,i,n,o){if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement))return!1;this.log("Starting standard replacement");const r=t.value,a=t.selectionStart??r.length,l=this.findTrigger(r.substring(0,a),e);if(!l)return this.log("Trigger not found"),!1;const c=r.substring(0,l.start),h=r.substring(a);if(n&&n.length>0&&o&&o.length>0)return await this.replaceWithChunks(t,c,h,n,o,e,s,i);const d=c+s+h;t.value=d;const p=c.length+(i??s.length);try{t.setSelectionRange(p,p)}catch{}return t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(10),this.verify(t,s,e)}async replaceWithChunks(t,e,s,i,n,o,r,a){this.log(`Replacing with ${i.length} chunks and ${n.length} actions`);let l=e;for(let c=0;c<i.length;c++){if(i[c].length===0&&c<i.length-1){c<n.length&&await this.executeKeyboardAction(t,n[c]);continue}l+=i[c],t.value=l+s,t.dispatchEvent(new Event("input",{bubbles:!0}));const h=l.length;try{t.setSelectionRange(h,h)}catch{}c<n.length&&await this.executeKeyboardAction(t,n[c])}if(a!==void 0){const c=e.length+a;try{t.setSelectionRange(c,c),this.log(`Set cursor to offset ${a} (absolute pos ${c})`)}catch(h){this.log("Failed to set cursor position:",h)}}return t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(10),this.verify(t,r,o)}}class G{constructor(){this.handlers=[],this.debugMode=!1,this.register(new _),this.register(new B),this.register(new U),this.register(new K),this.handlers.sort((t,e)=>e.priority-t.priority)}register(t){this.handlers.push(t)}setDebugMode(t){this.debugMode=t,this.handlers.forEach(e=>{"setDebugMode"in e&&e.setDebugMode(t)})}getHandler(t){for(const e of this.handlers)if(e.canHandle(t))return this.debugMode&&console.log(`TextBlitz: Selected handler: ${e.name}`),e;return null}getHandlerChain(t){return this.handlers.filter(e=>e.canHandle(t))}listHandlers(){return this.handlers.map(t=>`${t.name} (priority: ${t.priority})`)}}class E{constructor(){this.locks=new WeakMap}static getInstance(){return E.instance||(E.instance=new E),E.instance}isLocked(t){const e=this.locks.get(t);return e?Date.now()-e.lastExpansion<e.cooldownMs:!1}lock(t,e=500){return this.isLocked(t)?!1:(this.locks.set(t,{locked:!0,lastExpansion:Date.now(),cooldownMs:e}),!0)}unlock(t){const e=this.locks.get(t);e&&(e.locked=!1,e.lastExpansion=Date.now())}markFailed(t){this.locks.set(t,{locked:!0,lastExpansion:Date.now(),cooldownMs:5e3})}}const I=class I{static setDebugMode(t){this.debugMode=t,this.registry.setDebugMode(t),m.setDebugMode(t)}static log(...t){this.debugMode&&console.log("TextBlitz [Replacer]:",...t)}static async replace(t,e,s,i,n){const o=n||e,r={element:m.getElementContext(t),site:m.getSiteContext(),snippet:{trigger:e}};try{if(m.info("expansion","Starting replacement",r),!document.contains(t))return m.warn("expansion","Element not in document",r),!1;let a=b.stripNotes(s);a=await b.processCommands(a),i&&i!=="none"&&(a=q.transform(a,i,e));const l="{cursor}";let c;const h=a.lastIndexOf(l);if(h!==-1){const S=(a.match(/\{cursor\}/g)||[]).length;a=a.replace(/\{cursor\}/g,""),c=h-l.length*(S-1),this.log(`Cursor position: ${c} (removed ${S} markers)`)}const{chunks:d,actions:p}=b.splitTextByKeyboardActions(a),g=d.join("");this.log("Final expansion:",g),d.length>1&&this.log(`Split into ${d.length} chunks with ${p.length} actions`);const f=this.registry.getHandler(t);if(!f)return m.error("expansion","No handler available for element",r),!1;m.info("handler",`Using ${f.name} handler`,r);const w=this.getElementText(t),T=d.length>1&&p.length>0;if(await f.replace(t,o,g,c,T?d:void 0,T?p:void 0))return m.info("success",`${f.name} handler succeeded`,r),!0;m.warn("handler",`${f.name} handler failed, trying fallback chain`,r);const M=this.registry.getHandlerChain(t);for(const S of M){if(S===f)continue;if(m.info("fallback",`Trying fallback: ${S.name}`,r),await S.replace(t,o,g,c,T?d:void 0,T?p:void 0))return m.info("success",`Fallback ${S.name} succeeded`,r),!0}return m.error("fail","All handlers failed, rolling back",r),this.rollback(t,w),E.getInstance().markFailed(t),!1}catch(a){const l={...r,error:a instanceof Error?a.message:String(a)};return m.error("fail","Fatal error in replace",l),console.error("TextBlitz: Fatal error:",a),E.getInstance().markFailed(t),!1}}static getElementText(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?t.value:t.textContent||""}static rollback(t,e){try{t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement?(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0}))):t.isContentEditable&&(t.textContent=e,t.dispatchEvent(new Event("input",{bubbles:!0}))),this.log("Rolled back to previous content")}catch(s){console.error("TextBlitz: Rollback failed:",s)}}static isValidInputElement(t){return t instanceof HTMLInputElement&&t.type==="password"||t instanceof HTMLInputElement&&t.type==="hidden"||t instanceof HTMLInputElement&&["number","date","time","color","range","file","datetime-local","month","week"].includes(t.type)?!1:t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t.isContentEditable}static listHandlers(){return this.registry.listHandlers()}};I.debugMode=!1,I.registry=new G;let x=I;const W=new Set([" ","	",`
`,"\r",".",",",";",":","!","?","-","_","(",")","[","]","{","}",'"',"'","/","\\","|","<",">"]);function F(u){return u===void 0||u.length===0?!0:W.has(u)}function Y(u,t,e,s){const i=u.length>0?u[u.length-1]:void 0,n=e.length>0?e[0]:void 0;switch(s){case"anywhere":return!0;case"word":return F(i);case"word-both":const o=F(i),r=n!==void 0&&F(n);return o&&r;default:return console.warn("Unknown trigger mode:",s),!1}}class P{constructor(t){this.config=t}}class j extends P{constructor(){super(...arguments),this.baseURL="https://api.groq.com/openai/v1",this.model="llama-3.1-8b-instant"}async complete(t){const e=this.config.timeout||5e3,s=new AbortController,i=setTimeout(()=>s.abort(),e);try{const n=this.config.systemPrompt||"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",o=await fetch(`${this.baseURL}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.config.model||this.model,messages:[{role:"system",content:n},{role:"user",content:t.prompt}],max_tokens:t.maxTokens||100,temperature:t.temperature||.7}),signal:s.signal});if(clearTimeout(i),!o.ok){const c=await o.text();throw new Error(`Groq API error: ${o.status} - ${c}`)}const r=await o.json();if(!r.choices||r.choices.length===0)throw new Error("No response from Groq");const a=r.choices[0].message.content.trim(),l=r.usage||{prompt_tokens:0,completion_tokens:0,total_tokens:0};return{text:a,tokensUsed:{input:l.prompt_tokens,output:l.completion_tokens,total:l.total_tokens},model:r.model||this.model,provider:"groq"}}catch(n){throw clearTimeout(i),n.name==="AbortError"?new Error("Groq request timed out"):n}}async testConnection(){try{return await this.complete({prompt:'Say "test" and nothing else',maxTokens:10}),!0}catch{return!1}}getModelName(){return this.config.model||this.model}}class V extends P{constructor(){super(...arguments),this.baseURL="https://api.anthropic.com/v1",this.model="claude-sonnet-4-20250514",this.apiVersion="2023-06-01"}async complete(t){const e=this.config.timeout||5e3,s=new AbortController,i=setTimeout(()=>s.abort(),e);try{const n=this.config.systemPrompt||"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",o=await fetch(`${this.baseURL}/messages`,{method:"POST",headers:{"x-api-key":this.config.apiKey,"anthropic-version":this.apiVersion,"content-type":"application/json"},body:JSON.stringify({model:this.config.model||this.model,max_tokens:t.maxTokens||100,messages:[{role:"user",content:`${n}

${t.prompt}`}],temperature:t.temperature||.7}),signal:s.signal});if(clearTimeout(i),!o.ok){const c=await o.text();throw new Error(`Anthropic API error: ${o.status} - ${c}`)}const r=await o.json();if(!r.content||r.content.length===0)throw new Error("No response from Anthropic");const a=r.content[0].text.trim(),l=r.usage||{input_tokens:0,output_tokens:0};return{text:a,tokensUsed:{input:l.input_tokens,output:l.output_tokens,total:l.input_tokens+l.output_tokens},model:r.model||this.model,provider:"anthropic"}}catch(n){throw clearTimeout(i),n.name==="AbortError"?new Error("Anthropic request timed out"):n}}async testConnection(){try{return await this.complete({prompt:'Say "test" and nothing else',maxTokens:10}),!0}catch{return!1}}getModelName(){return this.config.model||this.model}}class X extends P{constructor(){super(...arguments),this.baseURL="https://api.openai.com/v1",this.model="gpt-4o-mini"}async complete(t){const e=this.config.timeout||5e3,s=new AbortController,i=setTimeout(()=>s.abort(),e);try{const n=this.config.systemPrompt||"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",o=await fetch(`${this.baseURL}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.config.model||this.model,messages:[{role:"system",content:n},{role:"user",content:t.prompt}],max_tokens:t.maxTokens||100,temperature:t.temperature||.7}),signal:s.signal});if(clearTimeout(i),!o.ok){const c=await o.text();throw new Error(`OpenAI API error: ${o.status} - ${c}`)}const r=await o.json();if(!r.choices||r.choices.length===0)throw new Error("No response from OpenAI");const a=r.choices[0].message.content.trim(),l=r.usage||{prompt_tokens:0,completion_tokens:0,total_tokens:0};return{text:a,tokensUsed:{input:l.prompt_tokens,output:l.completion_tokens,total:l.total_tokens},model:r.model||this.model,provider:"openai"}}catch(n){throw clearTimeout(i),n.name==="AbortError"?new Error("OpenAI request timed out"):n}}async testConnection(){try{return await this.complete({prompt:'Say "test" and nothing else',maxTokens:10}),!0}catch{return!1}}getModelName(){return this.config.model||this.model}}class Z extends P{constructor(){super(...arguments),this.baseURL="https://generativelanguage.googleapis.com/v1beta",this.model="gemini-1.5-flash"}async complete(t){const e=this.config.timeout||5e3,s=new AbortController,i=setTimeout(()=>s.abort(),e);try{const n=this.config.systemPrompt||"You are a text completion assistant. Output clean, paste-ready text with no quotes, markdown formatting, or explanations. Generate natural variations of the requested content. Keep responses under 50 words unless explicitly asked for more. Never ask questions back or include placeholders like [brackets]. Output only the exact text the user needs.",o=this.config.model||this.model,r=await fetch(`${this.baseURL}/models/${o}:generateContent?key=${this.config.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`${n}

${t.prompt}`}]}],generationConfig:{maxOutputTokens:t.maxTokens||100,temperature:t.temperature||.7}}),signal:s.signal});if(clearTimeout(i),!r.ok){const g=await r.text();throw new Error(`Gemini API error: ${r.status} - ${g}`)}const a=await r.json();if(!a.candidates||a.candidates.length===0)throw new Error("No response from Gemini");const l=a.candidates[0];if(!l.content||!l.content.parts||l.content.parts.length===0)throw new Error("Invalid response structure from Gemini");const c=l.content.parts[0].text.trim(),h=a.usageMetadata||{},d=h.promptTokenCount||0,p=h.candidatesTokenCount||0;return{text:c,tokensUsed:{input:d,output:p,total:d+p},model:o,provider:"gemini"}}catch(n){throw clearTimeout(i),n.name==="AbortError"?new Error("Gemini request timed out"):n}}async testConnection(){try{return await this.complete({prompt:'Say "test" and nothing else',maxTokens:10}),!0}catch{return!1}}getModelName(){return this.config.model||this.model}}const J={groq:{free:{requestsPerMinute:30,requestsPerDay:14400},paid:{requestsPerMinute:300,requestsPerDay:144e3}},openai:{tier1:{requestsPerMinute:500,tokensPerMinute:3e4},tier2:{requestsPerMinute:5e3,tokensPerMinute:45e4},tier3:{requestsPerMinute:5e3,tokensPerMinute:2e6},tier4:{requestsPerMinute:1e4,tokensPerMinute:4e6},tier5:{requestsPerMinute:1e4,tokensPerMinute:2e7}},anthropic:{tier1:{requestsPerMinute:50,tokensPerMinute:4e4},tier2:{requestsPerMinute:1e3,tokensPerMinute:8e4},tier3:{requestsPerMinute:2e3,tokensPerMinute:16e4},tier4:{requestsPerMinute:4e3,tokensPerMinute:4e5}},gemini:{free:{requestsPerMinute:15},paid:{requestsPerMinute:1500}}},Q={"llama-3.3-70b-versatile":{input:.59,output:.79},"llama-3.1-8b-instant":{input:.05,output:.08},"gpt-4o-mini":{input:.15,output:.6},"gpt-4o":{input:2.5,output:10},"claude-sonnet-4-20250514":{input:3,output:15},"claude-opus-4-20250514":{input:15,output:75},"gemini-2.0-flash-exp":{input:0,output:0},"gemini-2.5-pro":{input:1.25,output:5}};function O(u,t){const e=J[u];return e[t]||e[Object.keys(e)[0]]}function tt(u){return Q[u]||{input:0,output:0}}class et{constructor(){this.stats=new Map,this.loadStats()}async loadStats(){try{const t=await chrome.storage.local.get("llmUsage");if(t.llmUsage)for(const e of["groq","anthropic","openai","gemini"]){const s=t.llmUsage[e];s&&this.stats.set(e,s)}}catch(t){console.error("Failed to load LLM usage stats:",t)}}async saveStats(){try{const t={};for(const e of["groq","anthropic","openai","gemini"])this.stats.has(e)&&(t[e]=this.stats.get(e));await chrome.storage.local.set({llmUsage:t})}catch(t){console.error("Failed to save LLM usage stats:",t)}}async getOrCreateStats(t){if(!this.stats.has(t)){const s=(await y.getSettings()).llmModels[t]||"";this.stats.set(t,{provider:t,model:s,requests:0,tokensInput:0,tokensOutput:0,tokensTotal:0,estimatedCost:0,lastReset:Date.now(),requestsThisMinute:0,minuteWindowStart:Date.now()})}return this.stats.get(t)}async canMakeRequest(t){const e=await this.getOrCreateStats(t),s=await y.getSettings(),i=Date.now();i-e.minuteWindowStart>6e4&&(e.requestsThisMinute=0,e.minuteWindowStart=i);let n;if(s.llmCustomLimits?.[t]?.requestsPerMinute)n=s.llmCustomLimits[t].requestsPerMinute;else{const o=s.llmTiers[t]||this.getDefaultTier(t);n=O(t,o).requestsPerMinute}return e.requestsThisMinute<n}async trackRequest(t){const e=await this.getOrCreateStats(t.provider),s=Date.now();s-e.minuteWindowStart>6e4&&(e.requestsThisMinute=0,e.minuteWindowStart=s),e.requests++,e.requestsThisMinute++,e.tokensInput+=t.tokensUsed.input,e.tokensOutput+=t.tokensUsed.output,e.tokensTotal+=t.tokensUsed.total,e.model=t.model;const i=tt(t.model),n=t.tokensUsed.input/1e6*i.input,o=t.tokensUsed.output/1e6*i.output;e.estimatedCost+=n+o,await this.saveStats()}async getStats(t){return await this.getOrCreateStats(t)}async getAllStats(){return{groq:await this.getOrCreateStats("groq"),anthropic:await this.getOrCreateStats("anthropic"),openai:await this.getOrCreateStats("openai"),gemini:await this.getOrCreateStats("gemini")}}async resetStats(t){const e=await this.getOrCreateStats(t),i=(await y.getSettings()).llmModels[t]||"";e.model=i,e.requests=0,e.tokensInput=0,e.tokensOutput=0,e.tokensTotal=0,e.estimatedCost=0,e.lastReset=Date.now(),e.requestsThisMinute=0,e.minuteWindowStart=Date.now(),await this.saveStats()}async resetAllStats(){for(const t of["groq","anthropic","openai","gemini"])await this.resetStats(t)}async isApproachingLimit(t,e=80){const s=await this.getOrCreateStats(t),i=await y.getSettings();let n;if(i.llmCustomLimits?.[t]?.requestsPerMinute)n=i.llmCustomLimits[t].requestsPerMinute;else{const o=i.llmTiers[t]||this.getDefaultTier(t);n=O(t,o).requestsPerMinute}return s.requestsThisMinute>=n*(e/100)}async getRateLimit(t){const e=await y.getSettings();if(e.llmCustomLimits?.[t])return e.llmCustomLimits[t];const s=e.llmTiers[t]||this.getDefaultTier(t);return O(t,s)}getDefaultTier(t){return{groq:"free",openai:"tier1",anthropic:"tier1",gemini:"free"}[t]}}class st{constructor(){this.providers=new Map,this.usageTracker=new et}setProvider(t,e,s,i,n){let o;const r={apiKey:e,model:s,timeout:i,systemPrompt:n};switch(t){case"groq":o=new j(r);break;case"anthropic":o=new V(r);break;case"openai":o=new X(r);break;case"gemini":o=new Z(r);break;default:throw new Error(`Unknown provider: ${t}`)}this.providers.set(t,o)}async complete(t,e){const s=this.providers.get(t);if(!s)throw new Error(`Provider ${t} not initialized. Please add an API key in settings.`);if(!await this.usageTracker.canMakeRequest(t))throw new Error(`Rate limit exceeded for ${t}. Please wait a minute.`);await this.usageTracker.isApproachingLimit(t)&&console.warn(`TextBlitz: Approaching rate limit for ${t}`);const i=await s.complete(e);return await this.usageTracker.trackRequest(i),i}async testConnection(t){const e=this.providers.get(t);return e?e.testConnection():!1}getUsageTracker(){return this.usageTracker}}const z=new st;class it{constructor(){this.overlay=null,this.modal=null,this.onSubmit=null,this.onCancel=null}show(t,e,s){this.onSubmit=e,this.onCancel=s,this.overlay=document.createElement("div"),this.overlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
      z-index: 999999;
      display: flex;
      align-items: center;
      justify-content: center;
    `,this.modal=document.createElement("div"),this.modal.style.cssText=`
      background: white;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `,this.modal.innerHTML=`
      <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
        <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">
          Complete Snippet
        </h2>
        <p style="margin: 8px 0 0; font-size: 13px; color: #6b7280;">
          Fill in the fields below to insert your snippet
        </p>
      </div>
      <form id="textblitz-form" style="padding: 20px;">
        ${t.map(a=>this.renderField(a)).join("")}
      </form>
      <div style="padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; justify-content: flex-end;">
        <button
          type="button"
          id="textblitz-form-cancel"
          style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-size: 14px; font-weight: 500; cursor: pointer;"
        >
          Cancel
        </button>
        <button
          type="submit"
          form="textblitz-form"
          style="padding: 8px 16px; border: none; border-radius: 6px; background: #6366f1; color: white; font-size: 14px; font-weight: 500; cursor: pointer;"
        >
          Insert
        </button>
      </div>
    `,this.overlay.appendChild(this.modal),document.body.appendChild(this.overlay),this.modal.querySelector("#textblitz-form")?.addEventListener("submit",a=>{a.preventDefault(),this.handleSubmit(t)}),this.modal.querySelector("#textblitz-form-cancel")?.addEventListener("click",()=>this.handleCancel());const o=a=>{a.key==="Escape"&&(this.handleCancel(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o),this.modal.querySelector("input, textarea, select")?.focus()}renderField(t){const{type:e,name:s,label:i,options:n,defaultValue:o,required:r}=t;let a="";const l=r?"required":"",c=r?'<span style="color: #ef4444;">*</span>':"";switch(e){case"text":a=`
          <input
            type="text"
            name="${s}"
            id="${s}"
            value="${o||""}"
            ${l}
            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
          />
        `;break;case"paragraph":a=`
          <textarea
            name="${s}"
            id="${s}"
            rows="4"
            ${l}
            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; resize: vertical;"
          >${o||""}</textarea>
        `;break;case"menu":a=`
          <select
            name="${s}"
            id="${s}"
            ${l}
            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
          >
            ${n?.map(d=>`<option value="${d}">${d}</option>`).join("")||""}
          </select>
        `;break;case"date":a=`
          <input
            type="date"
            name="${s}"
            id="${s}"
            value="${o||""}"
            ${l}
            style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
          />
        `;break;case"toggle":a=`
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input
              type="checkbox"
              name="${s}"
              id="${s}"
              ${o===!0||o==="true"?"checked":""}
              style="width: 18px; height: 18px; cursor: pointer;"
            />
            <span style="font-size: 14px; color: #374151;">Enabled</span>
          </label>
        `;break}return`
      <div style="margin-bottom: 16px;">
        <label
          for="${s}"
          style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #111827;"
        >
          ${i} ${c}
        </label>
        ${a}
      </div>
    `}handleSubmit(t){const e=this.modal?.querySelector("#textblitz-form");if(!e)return;const s={};for(const i of t){const n=e.elements.namedItem(i.name);n&&(i.type==="toggle"?s[i.name]=n.checked:s[i.name]=n.value)}this.onSubmit?.(s),this.hide()}handleCancel(){this.onCancel?.(),this.hide()}hide(){this.overlay&&(this.overlay.remove(),this.overlay=null),this.modal=null,this.onSubmit=null,this.onCancel=null}}class nt{constructor(){this.settings=null,this.checkTimeout=null,this.trie=new N,this.formPopup=new it,this.lockManager=E.getInstance(),this.initialize()}async initialize(){try{if(await y.initialize(),this.settings=await y.getSettings(),x.setDebugMode(this.settings.debugMode),this.initializeLLMProviders(),!this.settings.enabled){console.log("TextBlitz: ❌ DISABLED in settings");return}const t=await y.getSnippets();this.trie.rebuild(t),this.setupListeners();const e=Object.keys(t).length;e===0?console.warn("TextBlitz: ⚠️ INITIALIZED but NO SNIPPETS FOUND!"):console.log("TextBlitz: ✅ Initialized with",e,"snippets")}catch(t){console.error("TextBlitz: ❌ Failed to initialize",t)}}initializeLLMProviders(){this.settings&&(this.settings.llmKeys.groq&&z.setProvider("groq",this.settings.llmKeys.groq,this.settings.llmModels.groq,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.llmKeys.anthropic&&z.setProvider("anthropic",this.settings.llmKeys.anthropic,this.settings.llmModels.anthropic,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.llmKeys.openai&&z.setProvider("openai",this.settings.llmKeys.openai,this.settings.llmModels.openai,this.settings.llmTimeout,this.settings.llmSystemPrompt),this.settings.llmKeys.gemini&&z.setProvider("gemini",this.settings.llmKeys.gemini,this.settings.llmModels.gemini,this.settings.llmTimeout,this.settings.llmSystemPrompt))}setupListeners(){document.addEventListener("input",this.handleInput.bind(this),!0),chrome.storage.onChanged.addListener((t,e)=>{e==="local"&&(t.snippets&&this.trie.rebuild(t.snippets.newValue||{}),t.settings&&(this.settings=t.settings.newValue,x.setDebugMode(this.settings.debugMode),this.initializeLLMProviders()))})}handleInput(t){if(!this.settings?.enabled)return;const e=t.target;if(x.isValidInputElement(e)){if(this.lockManager.isLocked(e)){this.settings.debugMode&&console.log("TextBlitz: Element is locked, skipping check");return}this.checkTimeout&&clearTimeout(this.checkTimeout),this.checkTimeout=window.setTimeout(()=>{this.checkForMatch(e)},10)}}async checkForMatch(t){const e=this.getTextBeforeCursor(t);if(!e)return;const s=this.trie.findMatch(e);if(!s)return;const{snippet:i}=s,n=i.caseSensitive?i.trigger:i.trigger.toLowerCase();if(!(i.caseSensitive?e:e.toLowerCase()).endsWith(n))return;const r=e.substring(e.length-n.length),a=e.substring(0,e.length-n.length);if(Y(a,n,"",i.triggerMode)){if(this.settings?.debugMode&&console.log("TextBlitz: ✅ Trigger matched:",n,"snippet:",i.label),!this.lockManager.lock(t)){this.settings?.debugMode&&console.log("TextBlitz: Failed to lock element, another expansion in progress");return}try{b.hasFormCommands(i.expansion)?await this.expandWithForm(t,i,r):i.type==="dynamic"?await this.expandDynamic(t,i,r):await x.replace(t,i.trigger,i.expansion,i.caseTransform,r)?y.incrementUsage(i.id).catch(c=>{console.error("TextBlitz: Failed to update usage stats",c)}):this.lockManager.markFailed(t)}catch(l){console.error("TextBlitz: Error during expansion:",l),this.lockManager.markFailed(t)}finally{this.lockManager.unlock(t)}}}getTextBeforeCursor(t){try{if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement){const e=t.selectionStart??t.value.length;return t.value.substring(0,e)}if(t.isContentEditable){const e=window.getSelection();if(!e||e.rangeCount===0)return t.textContent||"";const s=e.getRangeAt(0),i=s.cloneRange();return i.selectNodeContents(t),i.setEnd(s.endContainer,s.endOffset),i.toString()}return""}catch(e){return this.settings?.debugMode&&console.log("TextBlitz: Error getting text before cursor:",e),""}}async expandWithForm(t,e,s){const i=b.extractFormFields(e.expansion);if(i.length===0){console.warn("TextBlitz: No form fields found in expansion");return}await new Promise((n,o)=>{this.formPopup.show(i,async r=>{try{let a=b.substituteFormValues(e.expansion,r);a=await b.processCommands(a),await x.replace(t,e.trigger,a,e.caseTransform,s)&&y.incrementUsage(e.id).catch(c=>{console.error("TextBlitz: Failed to update usage stats",c)}),n()}catch(a){console.error("TextBlitz: Form expansion failed:",a),o(a)}},()=>{this.settings?.debugMode&&console.log("TextBlitz: Form cancelled by user"),n()})})}async expandDynamic(t,e,s){try{const i=e.llmProvider||this.settings.llmDefaultProvider,n=e.llmPrompt;if(!n)throw new Error("No LLM prompt defined for dynamic snippet");const o=await z.complete(i,{prompt:n,maxTokens:this.settings.llmMaxTokens,temperature:.7});await x.replace(t,e.trigger,o.text,e.caseTransform,s)&&y.incrementUsage(e.id).catch(a=>{console.error("TextBlitz: Failed to update usage stats",a)})}catch(i){console.error("TextBlitz: LLM expansion failed:",i);let n="LLM failed";i instanceof Error&&(i.message.includes("not initialized")||i.message.includes("API key")?n="LLM not configured - add API key in settings":i.message.includes("rate limit")?n="Rate limited - wait a moment":n=`LLM error: ${i.message}`),e.fallbackText?await x.replace(t,e.trigger,e.fallbackText,e.caseTransform,s):await x.replace(t,e.trigger,`[${n}]`,e.caseTransform,s)}}}m.info("init","Content script loaded",m.getSiteContext()),console.log("TextBlitz: Content script loaded!"),window.TextBlitzLogger=m,window.getTextBlitzDebugReport=()=>{const u=m.formatForGitHub();return console.log(u),console.log(`
📋 Debug report generated! Copy the text above and paste into GitHub issue.`),u},console.log("💡 Debug help: Run getTextBlitzDebugReport() to generate error report for GitHub");try{new nt}catch(u){m.error("init","Failed to create expander",{error:u instanceof Error?u.message:String(u)}),console.error("TextBlitz: Failed to create expander",u)}})();
