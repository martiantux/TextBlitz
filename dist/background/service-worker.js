import{S as p}from"../chunks/storage.js";chrome.runtime.onInstalled.addListener(async e=>{if(e.reason==="install"){console.log("TextBlitz: Extension installed"),await p.initialize();const o={"example-1":{id:"example-1",label:"By The Way",trigger:"btw",expansion:"by the way",caseSensitive:!1,enabled:!0,triggerMode:"word",createdAt:Date.now(),usageCount:0,type:"static"},"example-2":{id:"example-2",label:"Thank You",trigger:"thx",expansion:"thank you",caseSensitive:!1,enabled:!0,triggerMode:"word",createdAt:Date.now(),usageCount:0,type:"static"},"example-3":{id:"example-3",label:"Be Right Back",trigger:"brb",expansion:"be right back",caseSensitive:!1,enabled:!0,triggerMode:"word",createdAt:Date.now(),usageCount:0,type:"static"}};for(const t of Object.values(o))await p.saveSnippet(t);console.log("TextBlitz: Example snippets created")}});let u=!1;async function S(){if(!u)try{await chrome.offscreen.createDocument({url:"offscreen/offscreen.html",reasons:["CLIPBOARD"],justification:"Process snippet expansions with clipboard and command parsing"}),u=!0,console.log("TextBlitz: Offscreen document created")}catch(e){console.error("TextBlitz: Failed to create offscreen document",e)}}async function I(){(await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"]})).length===0&&(u=!1,await S())}chrome.runtime.onMessage.addListener((e,o,t)=>e.type==="PROCESS_SNIPPET"?(T(e).then(r=>t({success:!0,...r})).catch(r=>t({success:!1,error:r.message})),!0):(e.type==="INJECT_CKEDITOR_SCRIPT"&&P(e,o).then(r=>t(r)).catch(r=>t({success:!1,error:r.message})),!0));async function T(e){return await I(),await chrome.runtime.sendMessage(e)}async function P(e,o){try{if(!o.tab?.id)throw new Error("No tab ID available");const{targetId:t,trigger:r,expansion:h}=e;return(await chrome.scripting.executeScript({target:{tabId:o.tab.id},world:"MAIN",args:[t,r,h],func:(x,f,d)=>{try{const c=document.querySelector(`[data-textblitz-target="${x}"]`);if(!c)return{success:!1,error:"Element not found"};let i=c.ckeditorInstance;if(!i){let n=c.parentElement;for(;n&&!i;)i=n.ckeditorInstance,n=n.parentElement}if(!i)return{success:!1,error:"CKEditor instance not found"};const s=i.model,w=s.document.selection;return s.change(n=>{const a=w.getFirstPosition(),y=s.createRange(s.createPositionAt(a.root,0),a);let g="";for(const m of y.getItems())m.is("$textProxy")&&(g+=m.data);if(!g.endsWith(f))throw new Error("Trigger not found at cursor");const b=f.length,l=s.createPositionAt(a.root,a.offset-b),C=s.createRange(l,a);n.remove(C),n.insertText(d,l);const E=s.createPositionAt(a.root,l.offset+d.length);n.setSelection(E)}),{success:!0}}catch(c){return{success:!1,error:c.message}}}}))[0]?.result||{success:!1,error:"No result"}}catch(t){return console.error("TextBlitz: CKEditor injection error:",t),{success:!1,error:t.message}}}
