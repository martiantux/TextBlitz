import{S as p}from"../../chunks/storage.js";class S{constructor(){this.currentSnippetId=null,this.editor=null,this.draggedElement=null,this.initialize()}async initialize(){await p.initialize(),await this.loadFolders(),await this.applyTheme(),this.setupWYSIWYG(),this.setupEventListeners(),await this.loadSnippetData()}async applyTheme(){const t=(await p.getSettings()).darkMode||"system";let n=t;t==="system"&&(n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.body.setAttribute("data-theme",n)}async loadFolders(){const e=document.getElementById("snippet-folder");if(!e)return;const n=(await p.getSettings()).customFolders||[];let a='<option value="">No Folder</option>';a+='<option value="work">ðŸ’¼ Work</option>',a+='<option value="personal">ðŸ‘¤ Personal</option>',n.forEach(s=>{a+=`<option value="${s.id}">${s.icon} ${this.escapeHtml(s.name)}</option>`}),e.innerHTML=a}async loadSnippetData(){const t=new URLSearchParams(window.location.search).get("id");if(t){this.currentSnippetId=t;const n=await p.getSnippet(t);if(n){this.populateForm(n);const a=document.getElementById("editor-title");a&&(a.textContent="Edit Snippet")}else alert("Snippet not found"),this.navigateBack()}else{const n=await p.getSettings(),a=document.getElementById("snippet-folder");a&&n.lastUsedFolder&&(a.value=n.lastUsedFolder)}}populateForm(e){const t=document.getElementById("snippet-label"),n=document.getElementById("snippet-trigger"),a=document.getElementById("snippet-folder"),s=document.getElementById("snippet-type"),o=document.getElementById("snippet-trigger-mode"),i=document.getElementById("snippet-case-transform"),r=document.getElementById("snippet-enabled"),l=document.getElementById("snippet-case-sensitive"),f=document.getElementById("snippet-llm-provider"),d=document.getElementById("snippet-llm-prompt"),c=document.getElementById("snippet-fallback");t.value=e.label,n.value=e.trigger,a.value=e.folder||"",s.value=e.type||"static",o.value=e.triggerMode,i.value=e.caseTransform||"none",r.checked=e.enabled,l.checked=e.caseSensitive,e.type==="dynamic"?(f.value=e.llmProvider||"groq",d.value=e.llmPrompt||"",c.value=e.fallbackText||""):this.editor&&(this.editor.innerHTML=this.contentToHTML(e.expansion)),this.toggleTypeFields()}setupEventListeners(){document.getElementById("back-btn")?.addEventListener("click",()=>{this.navigateBack()}),document.getElementById("cancel-btn")?.addEventListener("click",()=>{this.navigateBack()}),document.getElementById("save-btn")?.addEventListener("click",()=>{this.saveSnippet()}),document.getElementById("snippet-type")?.addEventListener("change",()=>{this.toggleTypeFields()})}setupWYSIWYG(){this.editor=document.getElementById("wysiwyg-editor");const e=document.getElementById("wysiwyg-toolbar"),t=document.getElementById("command-menu"),n=document.getElementById("insert-command-btn"),a=document.getElementById("font-size");!this.editor||!e||(e.addEventListener("click",s=>{const o=s.target.closest("[data-command]");if(!o)return;s.preventDefault();const i=o.dataset.command;i&&(document.execCommand(i,!1,null),this.updateToolbarState(),this.editor?.focus())}),a?.addEventListener("change",s=>{const o=s.target;o.value&&(document.execCommand("fontSize",!1,o.value),this.updateToolbarState(),this.editor?.focus())}),this.editor.addEventListener("mouseup",()=>this.updateToolbarState()),this.editor.addEventListener("keyup",()=>this.updateToolbarState()),n?.addEventListener("click",s=>{s.stopPropagation(),t?.classList.toggle("show")}),document.addEventListener("click",s=>{s.target.closest(".insert-command-wrapper")||t?.classList.remove("show")}),t?.addEventListener("click",s=>{const o=s.target.closest("[data-cmd]");if(!o)return;const i=o.dataset.cmd;i&&(this.insertCommandPill(i),t.classList.remove("show"),this.editor?.focus())}),this.setupDragAndDrop(),this.setupCopyPaste(),this.setupAutoConvertCommands(),this.setupPillEdit(),this.setupDeleteButtons(),this.editor.focus())}updateToolbarState(){const e=document.getElementById("wysiwyg-toolbar");if(!e)return;e.querySelectorAll("[data-command]").forEach(n=>{const a=n.dataset.command;a&&document.queryCommandState(a)?n.classList.add("active"):n.classList.remove("active")})}insertCommandPill(e){if(!this.editor)return;if(e==="{cursor}"){const o=this.editor.querySelector('.command-pill[data-command="{cursor}"]');if(o){if(!confirm(`Only one {cursor} command is allowed per snippet.

Do you want to replace the existing {cursor}?`))return;o.remove()}}const t=document.createElement("span");t.className="command-pill",t.contentEditable="false",t.draggable=!0,t.setAttribute("data-command",e);const n=document.createTextNode(e);t.appendChild(n);const a=document.createElement("button");a.className="delete-btn",a.textContent="âœ•",a.setAttribute("aria-label","Delete command"),a.addEventListener("click",o=>{o.stopPropagation(),t.remove()}),t.appendChild(a);const s=window.getSelection();if(s&&s.rangeCount>0){const o=s.getRangeAt(0);o.deleteContents(),o.insertNode(t);const i=document.createTextNode("Â ");o.collapse(!1),o.insertNode(i),o.setStartAfter(i),o.setEndAfter(i),s.removeAllRanges(),s.addRange(o)}else this.editor.appendChild(t),this.editor.appendChild(document.createTextNode("Â "))}setupDragAndDrop(){this.editor&&(this.editor.addEventListener("dragstart",e=>{const t=e.target;t.classList.contains("command-pill")&&(this.draggedElement=t,t.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",t.outerHTML))}),this.editor.addEventListener("dragend",e=>{const t=e.target;t.classList.contains("command-pill")&&t.classList.remove("dragging")}),this.editor.addEventListener("dragover",e=>{this.draggedElement&&(e.preventDefault(),e.dataTransfer.dropEffect="move")}),this.editor.addEventListener("drop",e=>{if(!this.draggedElement)return;e.preventDefault();const t=document.caretRangeFromPoint(e.clientX,e.clientY);if(!t)return;this.draggedElement.remove(),t.insertNode(this.draggedElement);const n=document.createRange();n.setStartAfter(this.draggedElement),n.collapse(!0);const a=window.getSelection();a&&(a.removeAllRanges(),a.addRange(n)),this.draggedElement.classList.remove("dragging"),this.draggedElement=null,this.editor?.focus()}))}setupCopyPaste(){this.editor&&(this.editor.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData?.getData("text/plain");if(!t)return;if(/\{[^}]+\}/g.test(t)){const a=this.contentToHTML(t),s=window.getSelection();if(s&&s.rangeCount>0){const o=s.getRangeAt(0);o.deleteContents();const i=document.createElement("div");i.innerHTML=a;const r=document.createDocumentFragment();for(;i.firstChild;)r.appendChild(i.firstChild);o.insertNode(r),o.collapse(!1),s.removeAllRanges(),s.addRange(o)}}else document.execCommand("insertText",!1,t)}),this.editor.addEventListener("copy",e=>{const t=window.getSelection();if(!t||t.rangeCount===0)return;const a=t.getRangeAt(0).cloneContents(),s=document.createElement("div");s.appendChild(a);const o=this.htmlToContent(s.innerHTML);e.clipboardData?.setData("text/plain",o),e.preventDefault()}),this.editor.addEventListener("cut",e=>{const t=window.getSelection();if(!t||t.rangeCount===0)return;const n=t.getRangeAt(0),a=n.cloneContents(),s=document.createElement("div");s.appendChild(a);const o=this.htmlToContent(s.innerHTML);e.clipboardData?.setData("text/plain",o),n.deleteContents(),e.preventDefault()}))}setupAutoConvertCommands(){this.editor&&this.editor.addEventListener("input",e=>{const t=e;if(t.inputType!=="insertText"||t.data!=="}")return;const n=window.getSelection();if(!n||n.rangeCount===0)return;const a=n.getRangeAt(0),s=a.startContainer;let o="";s.nodeType===Node.TEXT_NODE&&(o=s.textContent?.substring(0,a.startOffset)||"");const i=o.lastIndexOf("{");if(i===-1)return;const r=o.substring(i)+"}";if(!this.isValidCommand(r))return;if(r==="{cursor}"){const m=this.editor?.querySelector('.command-pill[data-command="{cursor}"]');if(m){if(!confirm(`Only one {cursor} command is allowed per snippet.

Do you want to replace the existing {cursor}?`))return;m.remove()}}const l=r.length,f=a.startOffset-l+1,d=document.createRange();d.setStart(s,f),d.setEnd(s,a.startOffset),d.deleteContents();const c=document.createElement("span");c.className="command-pill",c.contentEditable="false",c.draggable=!0,c.setAttribute("data-command",r);const h=document.createTextNode(r);c.appendChild(h);const u=document.createElement("button");u.className="delete-btn",u.textContent="âœ•",u.setAttribute("aria-label","Delete command"),u.addEventListener("click",m=>{m.stopPropagation(),c.remove()}),c.appendChild(u),d.insertNode(c);const g=document.createTextNode("Â ");d.collapse(!1),d.insertNode(g),d.setStartAfter(g),d.setEndAfter(g),n.removeAllRanges(),n.addRange(d)})}isValidCommand(e){return[/^\{date(?::.+)?\}$/,/^\{time(?::.+)?\}$/,/^\{clipboard\}$/,/^\{cursor\}$/,/^\{enter\}$/,/^\{tab\}$/,/^\{delay(?:\s+\+?\d+(?:\.\d+)?(?:s|ms))?\}$/,/^\{key:\s*.+\}$/,/^\{formtext(?::.+)?\}$/,/^\{formparagraph(?::.+)?\}$/,/^\{formmenu(?::.+)?\}$/,/^\{formdate(?::.+)?\}$/,/^\{formtoggle(?::.+)?\}$/].some(n=>n.test(e))}setupPillEdit(){this.editor&&this.editor.addEventListener("dblclick",e=>{const t=e.target;t.classList.contains("command-pill")&&(e.preventDefault(),e.stopPropagation(),this.editPill(t))})}setupDeleteButtons(){this.editor&&this.editor.addEventListener("click",e=>{const t=e.target;if(!t.classList.contains("delete-btn"))return;e.preventDefault(),e.stopPropagation();const n=t.closest(".command-pill");n&&n.remove()})}editPill(e){const t=e.getAttribute("data-command")||e.textContent||"",n=document.createElement("input");n.type="text",n.value=t,n.style.cssText=`
      font-family: monospace;
      font-size: 13px;
      padding: 2px 6px;
      border: 2px solid #2196F3;
      border-radius: 4px;
      background: white;
      outline: none;
      min-width: 150px;
    `,e.style.display="none",e.parentNode?.insertBefore(n,e),n.focus(),n.select();const a=()=>{const o=n.value.trim();if(o&&this.isValidCommand(o)){if(o==="{cursor}"&&t!=="{cursor}"){const l=this.editor?.querySelector('.command-pill[data-command="{cursor}"]');if(l&&l!==e)if(confirm(`Only one {cursor} command is allowed per snippet.

Do you want to replace the existing {cursor}?`))l.remove();else{s();return}}e.innerHTML="",e.setAttribute("data-command",o);const i=document.createTextNode(o);e.appendChild(i);const r=document.createElement("button");r.className="delete-btn",r.textContent="âœ•",r.setAttribute("aria-label","Delete command"),r.addEventListener("click",l=>{l.stopPropagation(),e.remove()}),e.appendChild(r),e.style.display="",n.remove()}else alert("Invalid command syntax. Please check your command and try again."),n.focus()},s=()=>{e.style.display="",n.remove()};n.addEventListener("keydown",o=>{o.key==="Enter"?(o.preventDefault(),a()):o.key==="Escape"&&(o.preventDefault(),s())}),n.addEventListener("blur",()=>{setTimeout(()=>a(),100)})}toggleTypeFields(){const e=document.getElementById("snippet-type"),t=document.getElementById("dynamic-fields");e?.value==="dynamic"?t.style.display="block":t.style.display="none"}async saveSnippet(){const e=document.getElementById("snippet-label"),t=document.getElementById("snippet-trigger"),n=document.getElementById("snippet-folder"),a=document.getElementById("snippet-type"),s=document.getElementById("snippet-trigger-mode"),o=document.getElementById("snippet-case-transform"),i=document.getElementById("snippet-enabled"),r=document.getElementById("snippet-case-sensitive"),l=document.getElementById("snippet-llm-provider"),f=document.getElementById("snippet-llm-prompt"),d=document.getElementById("snippet-fallback"),c=e.value.trim(),h=t.value.trim(),u=a.value;if(!c){alert("Please enter a label for this snippet"),e.focus();return}if(!h){alert("Please enter a trigger for this snippet"),t.focus();return}let g="",m,y,E;if(u==="dynamic"){if(m=f.value.trim(),!m){alert("Please enter an LLM prompt for this dynamic snippet"),f.focus();return}y=l.value,E=d.value.trim()||void 0,g=m}else if(g=this.getEditorContent(),!g){alert("Please enter an expansion for this snippet"),this.editor?.focus();return}let v;this.currentSnippetId&&(v=await p.getSnippet(this.currentSnippetId));const C={id:this.currentSnippetId||`snippet-${Date.now()}`,label:c,trigger:h,expansion:g,folder:n.value||void 0,triggerMode:s.value,caseTransform:o.value,caseSensitive:r.checked,enabled:i.checked,type:u,llmProvider:y,llmPrompt:m,fallbackText:E,createdAt:v?.createdAt||Date.now(),usageCount:v?.usageCount||0,lastUsed:v?.lastUsed};if(await p.saveSnippet(C),!this.currentSnippetId){const b=await p.getSettings();b.lastUsedFolder=n.value||void 0,await p.saveSettings(b)}this.navigateBack()}getEditorContent(){return this.editor?this.htmlToContent(this.editor.innerHTML):""}htmlToContent(e){const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll(".command-pill").forEach(a=>{const s=a.getAttribute("data-command")||a.textContent||"";a.replaceWith(document.createTextNode(s))}),t.textContent||""}contentToHTML(e){const t=document.createElement("div");t.textContent=e;let n=t.innerHTML;const a=/\{[^}]+\}/g;return n=n.replace(a,s=>{const o=this.escapeHtml(s);return`<span class="command-pill" contenteditable="false" draggable="true" data-command="${o}">${o}<button class="delete-btn" aria-label="Delete command">âœ•</button></span>`}),n}navigateBack(){window.location.href="../options/options.html"}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}new S;
