import{S as d}from"../../chunks/storage.js";class b{constructor(){this.currentSnippetId=null,this.editor=null,this.draggedElement=null,this.initialize()}async initialize(){await d.initialize(),await this.loadFolders(),await this.applyTheme(),this.setupWYSIWYG(),this.setupEventListeners(),await this.loadSnippetData()}async applyTheme(){const t=(await d.getSettings()).darkMode||"system";let s=t;t==="system"&&(s=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.body.setAttribute("data-theme",s)}async loadFolders(){const e=document.getElementById("snippet-folder");if(!e)return;const s=(await d.getSettings()).customFolders||[];let n='<option value="">No Folder</option>';n+='<option value="work">ðŸ’¼ Work</option>',n+='<option value="personal">ðŸ‘¤ Personal</option>',s.forEach(a=>{n+=`<option value="${a.id}">${a.icon} ${this.escapeHtml(a.name)}</option>`}),e.innerHTML=n}async loadSnippetData(){const t=new URLSearchParams(window.location.search).get("id");if(t){this.currentSnippetId=t;const s=await d.getSnippet(t);if(s){this.populateForm(s);const n=document.getElementById("editor-title");n&&(n.textContent="Edit Snippet")}else alert("Snippet not found"),this.navigateBack()}else{const s=await d.getSettings(),n=document.getElementById("snippet-folder");n&&s.lastUsedFolder&&(n.value=s.lastUsedFolder)}}populateForm(e){const t=document.getElementById("snippet-label"),s=document.getElementById("snippet-trigger"),n=document.getElementById("snippet-folder"),a=document.getElementById("snippet-type"),o=document.getElementById("snippet-trigger-mode"),i=document.getElementById("snippet-case-transform"),g=document.getElementById("snippet-enabled"),u=document.getElementById("snippet-case-sensitive"),l=document.getElementById("snippet-llm-provider"),h=document.getElementById("snippet-llm-prompt"),r=document.getElementById("snippet-fallback");t.value=e.label,s.value=e.trigger,n.value=e.folder||"",a.value=e.type||"static",o.value=e.triggerMode,i.value=e.caseTransform||"none",g.checked=e.enabled,u.checked=e.caseSensitive,e.type==="dynamic"?(l.value=e.llmProvider||"groq",h.value=e.llmPrompt||"",r.value=e.fallbackText||""):this.editor&&(this.editor.innerHTML=this.contentToHTML(e.expansion)),this.toggleTypeFields()}setupEventListeners(){document.getElementById("back-btn")?.addEventListener("click",()=>{this.navigateBack()}),document.getElementById("cancel-btn")?.addEventListener("click",()=>{this.navigateBack()}),document.getElementById("save-btn")?.addEventListener("click",()=>{this.saveSnippet()}),document.getElementById("snippet-type")?.addEventListener("change",()=>{this.toggleTypeFields()})}setupWYSIWYG(){this.editor=document.getElementById("wysiwyg-editor");const e=document.getElementById("wysiwyg-toolbar"),t=document.getElementById("command-menu"),s=document.getElementById("insert-command-btn"),n=document.getElementById("font-size");!this.editor||!e||(e.addEventListener("click",a=>{const o=a.target.closest("[data-command]");if(!o)return;a.preventDefault();const i=o.dataset.command;i&&(document.execCommand(i,!1,null),this.updateToolbarState(),this.editor?.focus())}),n?.addEventListener("change",a=>{const o=a.target;o.value&&(document.execCommand("fontSize",!1,o.value),this.updateToolbarState(),this.editor?.focus())}),this.editor.addEventListener("mouseup",()=>this.updateToolbarState()),this.editor.addEventListener("keyup",()=>this.updateToolbarState()),s?.addEventListener("click",a=>{a.stopPropagation(),t?.classList.toggle("show")}),document.addEventListener("click",a=>{a.target.closest(".insert-command-wrapper")||t?.classList.remove("show")}),t?.addEventListener("click",a=>{const o=a.target.closest("[data-cmd]");if(!o)return;const i=o.dataset.cmd;i&&(this.insertCommandPill(i),t.classList.remove("show"),this.editor?.focus())}),this.setupDragAndDrop(),this.editor.focus())}updateToolbarState(){const e=document.getElementById("wysiwyg-toolbar");if(!e)return;e.querySelectorAll("[data-command]").forEach(s=>{const n=s.dataset.command;n&&document.queryCommandState(n)?s.classList.add("active"):s.classList.remove("active")})}insertCommandPill(e){if(!this.editor)return;const t=document.createElement("span");t.className="command-pill",t.contentEditable="false",t.draggable=!0,t.textContent=e,t.setAttribute("data-command",e);const s=window.getSelection();if(s&&s.rangeCount>0){const n=s.getRangeAt(0);n.deleteContents(),n.insertNode(t);const a=document.createTextNode("Â ");n.collapse(!1),n.insertNode(a),n.setStartAfter(a),n.setEndAfter(a),s.removeAllRanges(),s.addRange(n)}else this.editor.appendChild(t),this.editor.appendChild(document.createTextNode("Â "))}setupDragAndDrop(){this.editor&&(this.editor.addEventListener("dragstart",e=>{const t=e.target;t.classList.contains("command-pill")&&(this.draggedElement=t,t.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",t.outerHTML))}),this.editor.addEventListener("dragend",e=>{const t=e.target;t.classList.contains("command-pill")&&t.classList.remove("dragging")}),this.editor.addEventListener("dragover",e=>{this.draggedElement&&(e.preventDefault(),e.dataTransfer.dropEffect="move")}),this.editor.addEventListener("drop",e=>{if(!this.draggedElement)return;e.preventDefault();const t=document.caretRangeFromPoint(e.clientX,e.clientY);if(!t)return;this.draggedElement.remove(),t.insertNode(this.draggedElement);const s=document.createRange();s.setStartAfter(this.draggedElement),s.collapse(!0);const n=window.getSelection();n&&(n.removeAllRanges(),n.addRange(s)),this.draggedElement.classList.remove("dragging"),this.draggedElement=null,this.editor?.focus()}))}toggleTypeFields(){const e=document.getElementById("snippet-type"),t=document.getElementById("dynamic-fields");e?.value==="dynamic"?t.style.display="block":t.style.display="none"}async saveSnippet(){const e=document.getElementById("snippet-label"),t=document.getElementById("snippet-trigger"),s=document.getElementById("snippet-folder"),n=document.getElementById("snippet-type"),a=document.getElementById("snippet-trigger-mode"),o=document.getElementById("snippet-case-transform"),i=document.getElementById("snippet-enabled"),g=document.getElementById("snippet-case-sensitive"),u=document.getElementById("snippet-llm-provider"),l=document.getElementById("snippet-llm-prompt"),h=document.getElementById("snippet-fallback"),r=e.value.trim(),f=t.value.trim(),v=n.value;if(!r){alert("Please enter a label for this snippet"),e.focus();return}if(!f){alert("Please enter a trigger for this snippet"),t.focus();return}let c="",m,y,E;if(v==="dynamic"){if(m=l.value.trim(),!m){alert("Please enter an LLM prompt for this dynamic snippet"),l.focus();return}y=u.value,E=h.value.trim()||void 0,c=m}else if(c=this.getEditorContent(),!c){alert("Please enter an expansion for this snippet"),this.editor?.focus();return}let p;this.currentSnippetId&&(p=await d.getSnippet(this.currentSnippetId));const I={id:this.currentSnippetId||`snippet-${Date.now()}`,label:r,trigger:f,expansion:c,folder:s.value||void 0,triggerMode:a.value,caseTransform:o.value,caseSensitive:g.checked,enabled:i.checked,type:v,llmProvider:y,llmPrompt:m,fallbackText:E,createdAt:p?.createdAt||Date.now(),usageCount:p?.usageCount||0,lastUsed:p?.lastUsed};if(await d.saveSnippet(I),!this.currentSnippetId){const S=await d.getSettings();S.lastUsedFolder=s.value||void 0,await d.saveSettings(S)}this.navigateBack()}getEditorContent(){return this.editor?this.htmlToContent(this.editor.innerHTML):""}htmlToContent(e){const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll(".command-pill").forEach(n=>{const a=n.getAttribute("data-command")||n.textContent||"";n.replaceWith(document.createTextNode(a))}),t.textContent||""}contentToHTML(e){const t=document.createElement("div");t.textContent=e;let s=t.innerHTML;const n=/\{[^}]+\}/g;return s=s.replace(n,a=>`<span class="command-pill" contenteditable="false" draggable="true" data-command="${this.escapeHtml(a)}">${this.escapeHtml(a)}</span>`),s}navigateBack(){window.location.href="../options/options.html"}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}new b;
